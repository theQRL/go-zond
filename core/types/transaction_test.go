// Copyright 2014 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package types

import (
	"bytes"
	"encoding/json"
	"errors"
	"fmt"
	"math/big"
	"reflect"
	"testing"

	"github.com/theQRL/go-qrllib/dilithium"
	"github.com/theQRL/go-zond/common"
	"github.com/theQRL/go-zond/crypto/pqcrypto"
	"github.com/theQRL/go-zond/rlp"
)

// The values in those tests are from the Transaction Tests
// at github.com/ethereum/tests.
var (
	testAddr, _ = common.NewAddressFromString("Zb94f5374fce5edbc8e2a8697c15331677e6ebf0b")

	emptyEip2718Tx = NewTx(&DynamicFeeTx{
		ChainID:   big.NewInt(1),
		Nonce:     3,
		To:        &testAddr,
		Value:     big.NewInt(10),
		Gas:       25000,
		GasFeeCap: big.NewInt(1),
		GasTipCap: big.NewInt(0),
		Data:      common.FromHex("5544"),
	})

	signedEip2718Tx, _ = emptyEip2718Tx.WithSignatureAndPublicKey(
		NewShanghaiSigner(big.NewInt(1)),
		common.Hex2Bytes("b7201456a97b53b63465bdd1124965603b4640c1b8c6da6613162b7a81ef2fab219947995c1764ee187e5b6da7dde582efe587b2594f39ebe5da2a1f63a870d6b0f8a4f475e5c18348bc5989c68cf85cd6248e33f7d2868503afdc657eca54149208197c0bfdd0e99fdd684e2cfa156530b79860cee2ea307605a459557593d37e1896c8fe555e67be636eea94accc5bfbe25a72078186bf4529451920f3d1e7d574f45929303da672fc989e6cf68fc4fe6b69590b0476badfdef313aad4f617289daab28d021c18a4e5a99eff1095658114d3f43178ecca67bc1e915133a2ff5e0ec478c4c7309e98d5a08cf1e450911b572a837def3e2b2b6f925b627baa1937b6d7a783503de30368be3155c275ba420be1b54bf60f283f2fc08710cef3202d4fe8e140a525f079c68af5d26a8866e667b5882eae6487bbc269096e1a7cfe4c5317c403f19192c18517dc4b435523e9ae6e127734cf67b3684227f8d2ac2731fd4ec5e5837d2d7590e1645166336365a42356e5f589b2d5a3b71023b0b9e58b9eca14894e91e90334045783c518b2fdc4c2a821f8ec75f572f70f1f1d47acc0a16b14ede021069df12f1aa0f5c5dec3eba423a391613459c4183a93f8f201fcfebf8f6d8a39e1d7d1c0f84f266a0996599602f2732801d085425e3da02e04279f4e6a9c2cb842cd98b8d1e4474d61634f656ef5461c686a937a813c9870da18c7c9349ff437d5e8a81e8e396ab1f34c8c5ad3e46d6b22a128ed98d74a80f6df5e220112eaf72048c277e5715507ecb0edcf1cba57eaec9aac37b153484b701a0ca8114c03b1eb2e959e77420e0d256d34996cf12483ac1292ab28fd6eee3abefab5cc8cc32bd3ea91869dabccf215b10ed4f6d677bf9f81e4bdaffdfb3ad22231c9be7c2b0c3d3644ba27b5f08800a692145b33cc9d2acd376c06dd15bb6ef6fa898af54a4ed1c4d159c6c5fbc31513bb94cc5f30425f862f2920c479297931bef8e2682235882315d8134142f7f9fdaa2e1691f11af7da9d6ddfed38614088d1c6bef7f29d754262501c56610102418fbad35852bafe24eb16b771a62cae38403b5dbc9e687d152af5f76f669676d1638e2eff8d95e619006ee69dde5e5ee820ed694ef7ddd6582b87ac08d03305199c86d4e0e707d2d47dddd616cc45d7be552d0e4f40007e4b668a03e8e173466a8cab8eba12233a29987a9f117547e5d3def1659fc3520c08b37f24d6664eb9047ca034f6bf4e0bf4fa647218b0f7c8493d5380d0340a0c79664a18fd1dd0a6d6310dd0fbebf12d7b23793e13cc9d2eb5d6ea64bac4e28730b14d82d1e1ef9bb2f9ae5951caf372f0450cf565578dc8f4ede9eea4c0b24b9268ac6080f404b42bb3ea5c79e58b79d5006054cb58bc9f02ab30ac1195694e7ae29b104809e0032729b7c72b8042a8514e20d8791c2b9b1802e773d2761974b5d71cd63f9c386d7097c3bbe9aa32d55e50fba77c2a265be471dd26163744d2afe7760d81554faa9003ea4c33a2172d804061a41cda8f0f4f4e3ed88fad0e1c01b369c58455cd8686f6129f34c1f5d6d4d0bcadf0750025974181c42311824cabc4cbbefdcbcc0bba7dea0669f473a89c9296805edc01fa41d979a99eda429f1a85b490b81d95cd3b4d665d082247960d968ca9366dd67c2b469fab2d5f451eee33d4764103e77ac902db5bcc302c41d2f12988eb304b88399de5afff9e6402bdf2de7fdd70be20dcb71933e69898c40fe76e469059fbffde9cd7929417f4054f91e52ebad68b74dd4f13f5dd25ffb3895c73d0b8b565b93f66122ef7c35e2534cd9f7d9aca5398c98ab50d395d4732d6377a61e4a52ee99220fb1349a99d8f607d78349a5d615f4857c31ed7a80b4dd5cb7e6e3276e3b9a014c229476391046675d05de965395c39da6f0231d8d9c36f3ef8ffa7967ad169c8fda1483f8609d48a22f893d271698b0d67e12edb22c8676b45e744f3db5ecf34e6621a00bdecc2bc24c64d7097f85791808a086ec357b65a7d24ac34b9eab4dc2f2e261883c469228c6334c08775a164d7ca76878bdfbf364a72387b1e292a3aec03fde54c9a9769a637650128bb39ca94529283434aafbff424774da82efd0522abb8f95353bfbea22721143827381947dc2c1a0893857f61e3169783fe46bbf843744a20b42282e605d37c2cec00581765d5a96309c3cf04475c2069e3418893be428ac90f9ded721db5e78d09108e8f9467dadc1c1b03bc1c09a717cbd6f08c5df2dbed59866e39ae4bf02e98b223f4ed13b688793f9f3b025daf2e1cd77edde2f5627786ce50cc0a4833498e6ce1c341e9d21c84532579b59c232ab1fd483ed96f1a9929e8719362554a8fb05cd91312ed3c6228abc99b44d8e3d1b351639fc3d17473e5ac3c97284f748ff569a04e9ce9d94e0dd8c6edaf4929c2ad5e15c72f88a89ae4a705b1ce0590ea2f79d5ec5bdd78c786dd7d9ca4d9247fc6cc26ba40adf516b368da2308294e2c53aa4df2571c6a3807548c82236f9cec0d927beefcfadf12bd1302dd50185a5a7f1e8f949f5637c8db79001c813aa8219c890b5f715087ab547642628aefde3c72cba0920bd40581f139d9dac6e5bec00f52d22c7427fcd4ffe1051ca194d40e438c819280bfa94ea1002116f1435fb2e40b1424ddd737e0f6ce894c01399ef1f610f4f0ec2363c3867930b7ab183ab3d06d9a15651ee80deb8bb7df335e7903b09023ceb670961cf975a25efd4c58ead3a5f88eaefa9792175e594b96050cb93ad72ee9f56d9f8b30bfd390dc565995265ae8c3c63a12418c21258b1dfdf9a52b27c83cfda92923c3d4ed6b3b5a761f6ab2a2bf2a4617c2cd39000d12eb795784c87624db8a8d344151e2afa7f54b4dc6f586e409071e5dd1e352eec48fe4508ccb76ffea21ae08eca308361703c2cccbed58c8733db0e454dbdc2ab1b5301cf02683a72203f1e710fff0f53290b3a401c917f60ef5401d43ade09d57f32d4a2c079704cc21b255835d18778ae0b5f9707d5ce58b1d98c91f9953bee8fb902b59b5b1fac819a96965d13582ed7ed3b9dcaeaa665dd29ab904d960e988819a25596c2029769b7b2542da46104b2491b17d00fa7c9c18c565b944c8fc231a591a4ee9e309b50d17ed007f9a772feac4d27119197105769f4d5fb4def1c39fb3ea57f82088a37b4039da4d1ead2fa5eeae7d30a7b7f4e4784363428cd2edd855fc32fa825ebbc1c8d9d9a27e82f05c09ba2e533a33a58f5f216a983e254b21a58a0c470f8d526c59d94c85fb6e0ff40bb241035e5161503a105653147ee80e5f5792d78d6e4a6c6081d384d54c75c8683ed68620f889738827a6f7557dca4297ad5a7997cc0e87da43d4d793c80f1875cd2c32aa486a0477b5b6135626d295635b2207accba490bf6e14d1cdae7d58041a3816fd84cf7d9dbe81d5d2814c392ee54887d2a385f4ffdcce9ca77f6d7199be6d8a9de8f8df5732aee0f111b88340a2e2d265a11306060adf8dc996ff2f5c962e1cd12bc67161cd2efc0b964bbf351e9f9a48818cfb6b1141d788534f9e633355edcf3357e082ee9139056f4b8d849a7161b96b80a8f43fdfb66a4661ffaa91cbf174b4b7843f8ff27d81fba8d9b363a01e707fbda1b0329c23fb9436aad71e2b2befd06d4373376fb28d7b378d755cc9c8d6c12638b0dd77a844301b52a4201043f911679361c5cbe62140524961c58b53012a5e3b83a20c6a335de0c4a790acdd04fd18d53e726dbded093b45c66974f35a6862c2b6800ccfa1ee0febd5cd3e949e8177c9663e405129d444161981c37c8a537f61b5a0a97d7f0a9059145f2ea0197ecc0b8acd38c6f87e62e4369cc521255bdc85dcd9941de74f57ef564e373beb6272c5b676a88f7a06803c467e6e6a094cbc773511c66dfb6f39e2dbc8c24ba7a584ddad67b5e402040ee264333522cfeb37dc62dddf1d27937c2479280a909a3574c2e17c181d93c3a3a8d701fb989cb06724deca5a73cc68cf37b5cb7603bece3a8481df33e365c735c58230218b827cc4122c35f79cc87951df0a05ab226b5e81b0705a08f942782f69919df6c13dbc568bfdc494777bbdf8938855765702475af94ee42ca489f8b9e05e0e7b312d83a14d2eca43875c2bb5cc5932eed783f1fea5ad200a257ec97cf4ce67a3212ba6c22ed559173b596ec0232dcd38986b276dd62f5370fd600d66502b61049f35a5d23f73dfe85dfa2d0923d3efb50c307a9b677a3c97f29e83452781ca0a2b094a1c2c0b7442b50781bbbc65dc761aa7af7574c3fdfa07169992258edf6c417f03d27b943cd5a1553289d2194cee176ddba3e13d16754f52704d766f5c2ab25505c69e44ea5a83c8e13d33a668678cb4379a02e298f0de9bd7f0e7fad2a996f0ea82c1edbc01461f8622679b666b3ed696854587444a2545bf135695ddbfe27dd21d1a083f9d0af6eb5960471da7275de268d7e8933131c92c5c5f0760747e3520123f09ed2a23a1fe9b492401eb836ad8b91b16cf5666b5d91ba06e5ea6cc299d79e60e1d6dab60dc70ac8316c353ea744f40eb15aedd267109da7e211e1435621981812f7eb28c746637cc48564db06ca4edd30a9a5f1c5a17264c61a2089307b6118114132fe85a788251d06680529126dc488321794fdb699f30e7728dfe3730753b644d9007c8b59acd18363be21b10219a00f54305a2c12b12bb10b2abb27163cd1dbca94797bb62d064e2c2581d0d19d2d8f6538dd5486decf59ec4535b05cecfd55b8a192d5cca81cae25c33423906a5facd55681b4effae36c0dd152854a119d6be016b0784dd8919ecbb1bcaf71592c9e5263b25cbddf7e20c938e1b1e51b1462ffb738783f3beee5e3959b161c364b84381881b1473dd49ea71036cf3a69ee96363baae01d772bfaa39fbff49c90a8d6fcb25a2de1771165f7a29a9544579135bc95f86225fd0c5e87d228bb149647c6443ae19d1542e69cf476ee8410988c6776de146461c2a9c1994ddf20b4e3f89e9c76df9bc3a060fc34246ffde37e3bce7c6b120cc712bccb83c028624da822ed2bb881938df41ae679b4d0b10cace908474285e6fdd2afba21aee1e72a4c91aa833786c56d9f7a509eaca664d9725debaed1f230959b6c84e5d2b7895ad1a78e4179c40f84f371e492a7e9aea22f46d99419c8c365fa91129dabfb7923b41f80e5cc4fa1b1d9b43a1621df7a93e62c78681644061d7527a9d68b6ba338dd2f4f771aa9c09b9e494c2677005f54fb8588c6db75dc67d26f8da788d6ebbc7ad34e409e422d12eab8b541cc3739308ab634f0a660465563bf20bc44d1ed88694ef9c70e8fc811ee0a608d2da4cb99c1cce9a2434f6b9d1564e22693baded2185aa9112df4c530fe2a4d82578fba78f0644783edce72c86e5f13672f3e3a5882afeac33951c2616baa5a2005246c056a757d7a6f94e4cfffebc422907efd458dd99dc62e95dd0c487e3790e1d76726a12ffdf109b5bb2b6786a845d09725edc7157994ea2f4cb3ed3037eb5f0216cb6798ec1f14a16c9800d56003f726b6faf062767040b672acbb81a736d0180cf6ee482e610b9dace438397b19b8a34d1aa118d05b7e6b0ab7a4ae136e7a327e3b193f03e0578e8a704f1a54e055c1c637884ef00befaf7a5a3cbabdc1b64cd71ad5111401ca0db58ec2495d8a3f4145c9a527b65fc694d7db489523e1c42604c7d20be4281924005a1a1d4fba1d8934921b6fc470e988819f4ec0752d50d4ba2753194379ce6f4c2409acfb62b9a6feb5b8146dfb3f3fa145f73295b86dc381538a314dc64fb6f775d9a5768ff7e76ac17663105c2bb8a1fc7b61f186954a7a8395fb22fc1d19bb2a6fac68a4371541e220c4a8fd9b419985d39edeab4eca802d344bd56476518879afa2bc3ec475f2a48a7c0bfa780a5bf3193017b59b2d6aefd14e2c0dff8cd20587ac168afd89dfd2329811dee040ad6e04014a6c8b9339a46340d8c9fb37d8e4ef61750d96dbb4a8a5e4ddf8d6da78140ed66979c288bdfa72f8da9de0f3f2ab06499201b76679bc78b8b1f90c67c83d0615006020140831ece0efcf3927cccdca65ecd6285cdea6c60f2c358ab1898a50a7a5d67c8d8410f104cbb60fd7111af98a01dbcc1218b1521bc24b4cc2dfa01699747c48b3dbc2931579ed4789b1e0af610a8d703607c5d98040d0ee0a7fd962de7064b733d772ae3660301df821671e15bd7808c3554f66737dd0bacd29627fd8d8de8588d8b6bcf5e5ec65078b106205ad6bd8330bf1cb75cc8c70a34099536cfd698f3efa13d7ffd81483a16d8ebfa69dc32758510f6d3759aac0b79edd1ecc7b867bef1ad4e1cc980ef0c3ab254285a150c2ca8d620deee47b9e1eaebf1f7fd17697789bee0354f577780b1d4d9f1fb3b4d5d8badd1e0eb6a6f7f899aabed2a2f51f20000000000000000000000000000000000000000000000000004070f151f272e32"),
		common.Hex2Bytes("01727d783cc48b50060e8d3cf86eb8f37a5fe0dd49beb6c79e77aa4243aed4acdc5bed459f9ce1aaee191558c4791a698778f22ae0b670dbc963f9dff974c5c4c7bdf86504364cd48ecbd37c990758e92abc82f9ab42eefac09b5c307064540751421eff33e436f05f59c0a43a3c1b93442fb8b75bc4ca7156310162c935c50dfea28b8f8cb3409edb3a3b8242ddc9320f97e2e9f3d50f4428d791d7969e412ba10a2b22c6229395dd86f86261104f3cf37617d370d28f484b2605828f03b017d898baf4b4631212baef96e81c017dab349d8189a70f07bfe86240d5f5a33802ca794072aef09b4171b153af2b33a8b375a113438d271cb0fe625d76e8fcca390dcbb924abf7ac9bc5e6ea6ec38cc7b4fb38ac22ded5d9280260c53f87186e8a1f44eeca54fd915015daeaa57fa3493130dbc0e3b664df05bce6cfbe8c10c1a7b7963ec5d9f6e044995050bc169b62de61e37e91eb83e0f21aa11018edd4f2587b2c907e1f99fc93a30935a9a16c828e778acb8d04e70e6a4cf248a1f23088fcde603ae156e538c1f2cc07e959f1a0d5d8771ee207284edc9e5f34785f708a9f1395cdbbd17fdfaa0792d9ffa1af4dec2907b603698bc71621df7e34c6adf001951252b97d69590d7cbf7a102734aca33b3a337ce3deec222f2b8b61c45ad189a75dd30746ec7c9700fccf361b94b23564c974bd024b89a52d3f225d0b562e4500b51e0c447caeff5eb760d781c416aabf702c079baad87fdb18c61d50cc8827e407fe088a8da4575a92e13093d24c63ff37ac70bb2a6be9631891b0dd570a7fbb73bb66d489058ac89c46db31576a38dbe2a206a31f48751b45e1bf7934fd8fc2d242273aa1261ca679a6ce693a458a5a33d47d8b7a8aa61f62060424bcf911f147206c475842c16dd801e4ac32a8223215ad3a4e59deb4df0597a612c330af5a787f05327cc5cac9e8a9d151adfb0413b5a68f124d9f1cbe753137061f5beb8ec2b9be66ea23076f2d6da6624a983f76ad92235315a3883c2a321b013586c055941514d3a6d448ff1d6cef057e4ca26b944d44086f4df7970371464c56151221cb808f0e00818cd0ffa916b78e696132ccc71a795949a39f2a5a6acff20998c085e640c901f251998d15d6cb7092dc48e69284e4836e634db47664f926697055252be841a5a79603f8a2a419650a6f1ad7c6bdb11a391bdea76f4f68be08922f5ef08bff8c0d02d5aded7907642cc6cca4fd594f0fe4700efd15827ae2f4a9c7f8f629498f1992e4cb575ed9bedb1927bd57bde751624a34c8438892ac114cbe1aac962cf4fe199d2ff2a23cb1f8c3a3e6d78a8b44b66d8f25c3702bebbfb1974698ac701d263561a32cec56574e1eb9f289fac40fa441296d79ae4f0f51c8e9a50d7acc1779b5a47a806c692a1c49e99fafb63d2149eeb175aa7ef584cbb5504211fbe6585e30ba0edbb717decc3494ee984d5f3e56089f14ce7222c6573833377881a861fd763e4fb667c9e76c860ffdee0771465f5a37aad543e3fa5f024996dba344f6a1c24b245a45adc6a18ac4dd08bb0307910724007e344ad302b534dcf7dd2ac3966bd3668486ba361ac1390155c0e1334d3a79c631f889bb26dda72449129d4441e795f2c124cde229d4daf79bc9f15c562fc0f6faa47f6b757cf4c7d0d6271c1e47f3d01ac02938eef495ca61e051617f32693a17abacf604722025f72660979716407f15d56a71b1427019b2b8897a7991f6d9bead653b537670bf4c5e7bc54b8745b533ab4bb96b588bdeb2b4f713f25477688737dde64107d82feabc00a2689f27b1b58161b6281d9edd647b8d23e9442f2123c93365f6805cf903b8a802a2de6d5622407cb9d88512fcc9ba9f18c90cfaa80e1e9f985e9849c8b91d9cdc1f862135f6583aed4f5471124408a89081c0e14789ce8f2444dee55f789387e6e48e6212fd271a1e3a55de0c1e122c8772dc32d1ca77284eb4649e86ae6e5569a4cf840166970a21d79c50a8fc9b2d1c144ee79885ffdbc22737b03a110b3522ea5c26ae99f950aec20411cd1c2466df4d90c3ffe2ed9116b6c23a63299f6d7bbcf2a37368765d170297d900ca346fa60f0e6a3fccf2a01548219982c5e49444771e64619089da4c6263df7ac2693d9037800f68607a34d7eeb489b1a93030488d7cd407f4f2ab561701d884d7eeea39f79cf2f25c4da089f34ea3f3dc15da1bc43da8e7c12d1e0c05b107f10da1ea5a684331f2ecb696734b47407dc51a15ab9c9b98f31a42cb2e771696ab39378bbcfec21021bc42ffb1488920229589505bb6fc771edddb1818a081a5b8fc90eefba70091ea3fed3fe81f95f721570662eed03cfd759fb064e2401e634072557f025cce8affff8c062381b5e0291fb016292b5403848b419037d9bb6190045eb19454c2ea2debec95eb9d7f76f9546c922f96d1a04c537594ef5d26b226821a3527cebd56ac950c54e7fa0557e017e9a5974ae7defbe1fb3ba3037f89d12ea7f85253ef885af0da7b1e60a8637d1197b795a9d663723b94f1806b2938b5da325877d7b85ec544bbf311f75cb7e17999518cb473a5cb7875ba4e59a904cc09992313ee3f44890498af5443d983a4ad2669fee3c47d592e788c56419b1e93bdaa5434ce895506adde41e75f89dce82e6fc78cf0b85850808037c172d5a44848525d1f06cc7f3610adf434ae21c1313c438eaf9b0cd4d18d4f402279a7db469080ee807630b0388046551ca3476914e3a2a2abc0b7fc211fc17a48c0b42800406738dce93b19a64dcc3cb93435ec117462ddcfd396daf99acd0bf2037a21fce0a46dbbfd974121669287f409a778b538f862eade58da183e9bd37c763a16f56b15d8d0c8ab6326189ca7116c587b87659ae82be17639362ecaa78f7ad346ae82a8f85bdf0ddc38054b9239ce975ee723ffc854ae4d028c20dae5d7cbd1b110dd749049c89878f797a20fc15ea9f6839c130253d4fa6d506fecd3605a8dfa35b13ff61e2f9d865224df588cf8d51d00341b8c607b64158903c171d76e7b303d0d1349374f6f06f080db74f55ecbbf8a038cc209bc4d86d63d9c8b7309a423b29048abdfb8849196bdea7a2a55a9b6f3c4e8019cc80bde6e6ddff2bac293c50f4f739a21331495b960a242d2d126832283f09a9d0ef145ca9cd5b513c7d72e2670717709e169e03d4d618ba6c319ac03a4c65cf7cdd050745f0ce0f7872fff4640741284ee26f1585e05978e53e1fff5a89322e9b770bc29c697e9843157f9f797f37ed45f9992e333d780fb71ea992624c195d0e8dc008877a5adaa89d8aef5b6533c2481208a946a5b32f3c95e4e518fc1c2e76bbceee2ce18703ce38e86cc09bdfda8b90c0beb6a7ce0321f9f8acd27f93800cc79dfd671825974516554e68ed1953a80d9e1a51717f06e2392612843eb73783eb74d1db18ee8c56929ac41bec655957cccf68ab3810cfb099aea1a1d7e064afe0b248d60d8aca916bc5529555ad94af922481f535f60a060ec63b887b183378355a827dc0da8a87fef209dd79ad207c482423f2d45fd4e4e8019122afe9bf5e4fac379567c13f44c35061fbdab4939f429354f4841cb1f15ec30fd69b361596e1259edb9f506a80dcd5a17786f4eb8e35fc1556fc9fbdf18d9"),
	)
)

func TestDecodeEmptyTypedTx(t *testing.T) {
	input := []byte{0x80}
	var tx Transaction
	err := rlp.DecodeBytes(input, &tx)
	if err != errShortTypedTx {
		t.Fatal("wrong error:", err)
	}
}

func TestEIP2718TransactionSigHash(t *testing.T) {
	s := NewShanghaiSigner(big.NewInt(1))
	if s.Hash(emptyEip2718Tx) != common.HexToHash("cf171c2aadabcb1e36975d0949d3b831188b555b7764342bf7b1b47238c428e4") {
		t.Errorf("empty EIP-2718 transaction hash mismatch, got %x", s.Hash(emptyEip2718Tx))
	}
	if s.Hash(signedEip2718Tx) != common.HexToHash("cf171c2aadabcb1e36975d0949d3b831188b555b7764342bf7b1b47238c428e4") {
		t.Errorf("signed EIP-2718 transaction hash mismatch, got %x", s.Hash(signedEip2718Tx))
	}
}

// This test checks signature operations on access list transactions.
func TestEIP2930Signer(t *testing.T) {
	var (
		key, _  = pqcrypto.HexToDilithium("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		keyAddr = common.Address(key.GetAddress())
		signer1 = NewShanghaiSigner(big.NewInt(1))
		signer2 = NewShanghaiSigner(big.NewInt(2))
		tx0     = NewTx(&DynamicFeeTx{Nonce: 1})
		tx1     = NewTx(&DynamicFeeTx{ChainID: big.NewInt(1), Nonce: 1})
		tx2, _  = SignNewTx(key, signer2, &DynamicFeeTx{ChainID: big.NewInt(2), Nonce: 1})
		to, _   = common.NewAddressFromString("Zcccccccccccccccccccccccccccccccccccccccc")
		tx3, _  = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:      common.Hex2Bytes("00"),
			Value:     big.NewInt(0),
			ChainID:   big.NewInt(1),
			Nonce:     1,
			Gas:       4000000,
			GasFeeCap: big.NewInt(2000),
			GasTipCap: big.NewInt(10),
			To:        &to,
			AccessList: []AccessTuple{
				{
					Address: to,
					StorageKeys: []common.Hash{
						common.HexToHash("0000000000000000000000000000000000000000000000000000000000000000"),
						common.HexToHash("0000000000000000000000000000000000000000000000000000000000000001"),
					},
				},
			},
		})
		to2, _ = common.NewAddressFromString("Zc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2")
		tx4, _ = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:       common.Hex2Bytes("095ea7b30000000000000000000000001111111254eeb25477b68fb85ed929f73a960582ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),
			Value:      big.NewInt(0),
			ChainID:    big.NewInt(1),
			Nonce:      47,
			Gas:        53319,
			GasFeeCap:  big.NewInt(14358031378),
			GasTipCap:  big.NewInt(576312105),
			To:         &to2,
			AccessList: []AccessTuple{},
		})
		to3, _ = common.NewAddressFromString("Z535b918f3724001fd6fb52fcc6cbc220592990a3")
		tx5, _ = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:       []byte{},
			Value:      big.NewInt(73360267083380739),
			ChainID:    big.NewInt(1),
			Nonce:      132949,
			Gas:        30000,
			GasFeeCap:  big.NewInt(14237787676),
			GasTipCap:  big.NewInt(0),
			To:         &to3,
			AccessList: []AccessTuple{},
		})
	)

	tests := []struct {
		tx             *Transaction
		signer         Signer
		wantSignerHash common.Hash
		wantSenderErr  error
		wantSignErr    error
		wantHash       common.Hash // after signing
	}{
		{
			tx:             tx0,
			signer:         signer1,
			wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
			wantSenderErr:  ErrInvalidChainId,
			wantHash:       common.HexToHash("c731c1b0e51ecfc23baabaeaf8b3b839a50f4b66f2caae92c6e3512a781c2c76"),
		},
		// NOTE(rgeraldes24): not valid atm
		/*
			{
				tx:             tx1,
				signer:         signer1,
				wantSenderErr:  ErrInvalidSig,
				wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
				wantHash:       common.HexToHash("1ccd12d8bbdb96ea391af49a35ab641e219b2dd638dea375f2bc94dd290f2549"),
			},
		*/
		{
			// This checks what happens when trying to sign an unsigned tx for the wrong chain.
			tx:             tx1,
			signer:         signer2,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: common.HexToHash("b0759fc55582f3e60ded82843dcc17733d8c65f543d2cf2613a47a5c6ac9fc48"),
			wantSignErr:    ErrInvalidChainId,
		},
		{
			// This checks what happens when trying to re-sign a signed tx for the wrong chain.
			tx:             tx2,
			signer:         signer1,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
			wantSignErr:    ErrInvalidChainId,
		},
		{
			// zvmone example
			tx:             tx3,
			signer:         signer1,
			wantSignerHash: common.HexToHash("00c89f03a2c0fe998bcccb984e0a6ec7c1eeabc6f46657915a402a3247219d28"),
			wantHash:       common.HexToHash("167da6f024b270d25a7ca05c1bf373c9636517b16a4b5f7a9fb975a668dc00e9"),
		},
		{
			// zvmone example
			tx:             tx4,
			signer:         signer1,
			wantSignerHash: common.HexToHash("840f004a0ca908700b48a591f09afb36132e0767109c0485ab94f1daf115d4a8"),
			wantHash:       common.HexToHash("53cea615852ed646b052395a3349eca21a141a0d1abfaa2fe4af284059162785"),
		},
		{
			// zvmone example
			tx:             tx5,
			signer:         signer1,
			wantSignerHash: common.HexToHash("2004db20334ebe7941961d9abd937b952bb688f9a5d58b998b24a8179c8dac6f"),
			wantHash:       common.HexToHash("3e31bab04d22c2db320644ffea4366b99cb866f17f28a1d0069871f97d5bac7f"),
		},
	}

	for i, test := range tests {
		sigHash := test.signer.Hash(test.tx)
		if sigHash != test.wantSignerHash {
			t.Errorf("test %d: wrong sig hash: got %x, want %x", i, sigHash, test.wantSignerHash)
		}
		sender, err := Sender(test.signer, test.tx)
		if !errors.Is(err, test.wantSenderErr) {
			t.Errorf("test %d: wrong Sender error %q", i, err)
		}
		if err == nil && sender != keyAddr {
			t.Errorf("test %d: wrong sender address %x", i, sender)
		}
		signedTx, err := SignTx(test.tx, test.signer, key)
		if !errors.Is(err, test.wantSignErr) {
			t.Fatalf("test %d: wrong SignTx error %q", i, err)
		}
		if signedTx != nil {
			if signedTx.Hash() != test.wantHash {
				t.Errorf("test %d: wrong tx hash after signing: got %x, want %x", i, signedTx.Hash(), test.wantHash)
			}
		}
	}
}

func TestEIP2718TransactionEncode(t *testing.T) {
	// RLP representation
	{
		have, err := rlp.EncodeToBytes(signedEip2718Tx)
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := common.FromHex("b91c3e02f91c3a010380018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c0b90a2001727d783cc48b50060e8d3cf86eb8f37a5fe0dd49beb6c79e77aa4243aed4acdc5bed459f9ce1aaee191558c4791a698778f22ae0b670dbc963f9dff974c5c4c7bdf86504364cd48ecbd37c990758e92abc82f9ab42eefac09b5c307064540751421eff33e436f05f59c0a43a3c1b93442fb8b75bc4ca7156310162c935c50dfea28b8f8cb3409edb3a3b8242ddc9320f97e2e9f3d50f4428d791d7969e412ba10a2b22c6229395dd86f86261104f3cf37617d370d28f484b2605828f03b017d898baf4b4631212baef96e81c017dab349d8189a70f07bfe86240d5f5a33802ca794072aef09b4171b153af2b33a8b375a113438d271cb0fe625d76e8fcca390dcbb924abf7ac9bc5e6ea6ec38cc7b4fb38ac22ded5d9280260c53f87186e8a1f44eeca54fd915015daeaa57fa3493130dbc0e3b664df05bce6cfbe8c10c1a7b7963ec5d9f6e044995050bc169b62de61e37e91eb83e0f21aa11018edd4f2587b2c907e1f99fc93a30935a9a16c828e778acb8d04e70e6a4cf248a1f23088fcde603ae156e538c1f2cc07e959f1a0d5d8771ee207284edc9e5f34785f708a9f1395cdbbd17fdfaa0792d9ffa1af4dec2907b603698bc71621df7e34c6adf001951252b97d69590d7cbf7a102734aca33b3a337ce3deec222f2b8b61c45ad189a75dd30746ec7c9700fccf361b94b23564c974bd024b89a52d3f225d0b562e4500b51e0c447caeff5eb760d781c416aabf702c079baad87fdb18c61d50cc8827e407fe088a8da4575a92e13093d24c63ff37ac70bb2a6be9631891b0dd570a7fbb73bb66d489058ac89c46db31576a38dbe2a206a31f48751b45e1bf7934fd8fc2d242273aa1261ca679a6ce693a458a5a33d47d8b7a8aa61f62060424bcf911f147206c475842c16dd801e4ac32a8223215ad3a4e59deb4df0597a612c330af5a787f05327cc5cac9e8a9d151adfb0413b5a68f124d9f1cbe753137061f5beb8ec2b9be66ea23076f2d6da6624a983f76ad92235315a3883c2a321b013586c055941514d3a6d448ff1d6cef057e4ca26b944d44086f4df7970371464c56151221cb808f0e00818cd0ffa916b78e696132ccc71a795949a39f2a5a6acff20998c085e640c901f251998d15d6cb7092dc48e69284e4836e634db47664f926697055252be841a5a79603f8a2a419650a6f1ad7c6bdb11a391bdea76f4f68be08922f5ef08bff8c0d02d5aded7907642cc6cca4fd594f0fe4700efd15827ae2f4a9c7f8f629498f1992e4cb575ed9bedb1927bd57bde751624a34c8438892ac114cbe1aac962cf4fe199d2ff2a23cb1f8c3a3e6d78a8b44b66d8f25c3702bebbfb1974698ac701d263561a32cec56574e1eb9f289fac40fa441296d79ae4f0f51c8e9a50d7acc1779b5a47a806c692a1c49e99fafb63d2149eeb175aa7ef584cbb5504211fbe6585e30ba0edbb717decc3494ee984d5f3e56089f14ce7222c6573833377881a861fd763e4fb667c9e76c860ffdee0771465f5a37aad543e3fa5f024996dba344f6a1c24b245a45adc6a18ac4dd08bb0307910724007e344ad302b534dcf7dd2ac3966bd3668486ba361ac1390155c0e1334d3a79c631f889bb26dda72449129d4441e795f2c124cde229d4daf79bc9f15c562fc0f6faa47f6b757cf4c7d0d6271c1e47f3d01ac02938eef495ca61e051617f32693a17abacf604722025f72660979716407f15d56a71b1427019b2b8897a7991f6d9bead653b537670bf4c5e7bc54b8745b533ab4bb96b588bdeb2b4f713f25477688737dde64107d82feabc00a2689f27b1b58161b6281d9edd647b8d23e9442f2123c93365f6805cf903b8a802a2de6d5622407cb9d88512fcc9ba9f18c90cfaa80e1e9f985e9849c8b91d9cdc1f862135f6583aed4f5471124408a89081c0e14789ce8f2444dee55f789387e6e48e6212fd271a1e3a55de0c1e122c8772dc32d1ca77284eb4649e86ae6e5569a4cf840166970a21d79c50a8fc9b2d1c144ee79885ffdbc22737b03a110b3522ea5c26ae99f950aec20411cd1c2466df4d90c3ffe2ed9116b6c23a63299f6d7bbcf2a37368765d170297d900ca346fa60f0e6a3fccf2a01548219982c5e49444771e64619089da4c6263df7ac2693d9037800f68607a34d7eeb489b1a93030488d7cd407f4f2ab561701d884d7eeea39f79cf2f25c4da089f34ea3f3dc15da1bc43da8e7c12d1e0c05b107f10da1ea5a684331f2ecb696734b47407dc51a15ab9c9b98f31a42cb2e771696ab39378bbcfec21021bc42ffb1488920229589505bb6fc771edddb1818a081a5b8fc90eefba70091ea3fed3fe81f95f721570662eed03cfd759fb064e2401e634072557f025cce8affff8c062381b5e0291fb016292b5403848b419037d9bb6190045eb19454c2ea2debec95eb9d7f76f9546c922f96d1a04c537594ef5d26b226821a3527cebd56ac950c54e7fa0557e017e9a5974ae7defbe1fb3ba3037f89d12ea7f85253ef885af0da7b1e60a8637d1197b795a9d663723b94f1806b2938b5da325877d7b85ec544bbf311f75cb7e17999518cb473a5cb7875ba4e59a904cc09992313ee3f44890498af5443d983a4ad2669fee3c47d592e788c56419b1e93bdaa5434ce895506adde41e75f89dce82e6fc78cf0b85850808037c172d5a44848525d1f06cc7f3610adf434ae21c1313c438eaf9b0cd4d18d4f402279a7db469080ee807630b0388046551ca3476914e3a2a2abc0b7fc211fc17a48c0b42800406738dce93b19a64dcc3cb93435ec117462ddcfd396daf99acd0bf2037a21fce0a46dbbfd974121669287f409a778b538f862eade58da183e9bd37c763a16f56b15d8d0c8ab6326189ca7116c587b87659ae82be17639362ecaa78f7ad346ae82a8f85bdf0ddc38054b9239ce975ee723ffc854ae4d028c20dae5d7cbd1b110dd749049c89878f797a20fc15ea9f6839c130253d4fa6d506fecd3605a8dfa35b13ff61e2f9d865224df588cf8d51d00341b8c607b64158903c171d76e7b303d0d1349374f6f06f080db74f55ecbbf8a038cc209bc4d86d63d9c8b7309a423b29048abdfb8849196bdea7a2a55a9b6f3c4e8019cc80bde6e6ddff2bac293c50f4f739a21331495b960a242d2d126832283f09a9d0ef145ca9cd5b513c7d72e2670717709e169e03d4d618ba6c319ac03a4c65cf7cdd050745f0ce0f7872fff4640741284ee26f1585e05978e53e1fff5a89322e9b770bc29c697e9843157f9f797f37ed45f9992e333d780fb71ea992624c195d0e8dc008877a5adaa89d8aef5b6533c2481208a946a5b32f3c95e4e518fc1c2e76bbceee2ce18703ce38e86cc09bdfda8b90c0beb6a7ce0321f9f8acd27f93800cc79dfd671825974516554e68ed1953a80d9e1a51717f06e2392612843eb73783eb74d1db18ee8c56929ac41bec655957cccf68ab3810cfb099aea1a1d7e064afe0b248d60d8aca916bc5529555ad94af922481f535f60a060ec63b887b183378355a827dc0da8a87fef209dd79ad207c482423f2d45fd4e4e8019122afe9bf5e4fac379567c13f44c35061fbdab4939f429354f4841cb1f15ec30fd69b361596e1259edb9f506a80dcd5a17786f4eb8e35fc1556fc9fbdf18d9b911f3b7201456a97b53b63465bdd1124965603b4640c1b8c6da6613162b7a81ef2fab219947995c1764ee187e5b6da7dde582efe587b2594f39ebe5da2a1f63a870d6b0f8a4f475e5c18348bc5989c68cf85cd6248e33f7d2868503afdc657eca54149208197c0bfdd0e99fdd684e2cfa156530b79860cee2ea307605a459557593d37e1896c8fe555e67be636eea94accc5bfbe25a72078186bf4529451920f3d1e7d574f45929303da672fc989e6cf68fc4fe6b69590b0476badfdef313aad4f617289daab28d021c18a4e5a99eff1095658114d3f43178ecca67bc1e915133a2ff5e0ec478c4c7309e98d5a08cf1e450911b572a837def3e2b2b6f925b627baa1937b6d7a783503de30368be3155c275ba420be1b54bf60f283f2fc08710cef3202d4fe8e140a525f079c68af5d26a8866e667b5882eae6487bbc269096e1a7cfe4c5317c403f19192c18517dc4b435523e9ae6e127734cf67b3684227f8d2ac2731fd4ec5e5837d2d7590e1645166336365a42356e5f589b2d5a3b71023b0b9e58b9eca14894e91e90334045783c518b2fdc4c2a821f8ec75f572f70f1f1d47acc0a16b14ede021069df12f1aa0f5c5dec3eba423a391613459c4183a93f8f201fcfebf8f6d8a39e1d7d1c0f84f266a0996599602f2732801d085425e3da02e04279f4e6a9c2cb842cd98b8d1e4474d61634f656ef5461c686a937a813c9870da18c7c9349ff437d5e8a81e8e396ab1f34c8c5ad3e46d6b22a128ed98d74a80f6df5e220112eaf72048c277e5715507ecb0edcf1cba57eaec9aac37b153484b701a0ca8114c03b1eb2e959e77420e0d256d34996cf12483ac1292ab28fd6eee3abefab5cc8cc32bd3ea91869dabccf215b10ed4f6d677bf9f81e4bdaffdfb3ad22231c9be7c2b0c3d3644ba27b5f08800a692145b33cc9d2acd376c06dd15bb6ef6fa898af54a4ed1c4d159c6c5fbc31513bb94cc5f30425f862f2920c479297931bef8e2682235882315d8134142f7f9fdaa2e1691f11af7da9d6ddfed38614088d1c6bef7f29d754262501c56610102418fbad35852bafe24eb16b771a62cae38403b5dbc9e687d152af5f76f669676d1638e2eff8d95e619006ee69dde5e5ee820ed694ef7ddd6582b87ac08d03305199c86d4e0e707d2d47dddd616cc45d7be552d0e4f40007e4b668a03e8e173466a8cab8eba12233a29987a9f117547e5d3def1659fc3520c08b37f24d6664eb9047ca034f6bf4e0bf4fa647218b0f7c8493d5380d0340a0c79664a18fd1dd0a6d6310dd0fbebf12d7b23793e13cc9d2eb5d6ea64bac4e28730b14d82d1e1ef9bb2f9ae5951caf372f0450cf565578dc8f4ede9eea4c0b24b9268ac6080f404b42bb3ea5c79e58b79d5006054cb58bc9f02ab30ac1195694e7ae29b104809e0032729b7c72b8042a8514e20d8791c2b9b1802e773d2761974b5d71cd63f9c386d7097c3bbe9aa32d55e50fba77c2a265be471dd26163744d2afe7760d81554faa9003ea4c33a2172d804061a41cda8f0f4f4e3ed88fad0e1c01b369c58455cd8686f6129f34c1f5d6d4d0bcadf0750025974181c42311824cabc4cbbefdcbcc0bba7dea0669f473a89c9296805edc01fa41d979a99eda429f1a85b490b81d95cd3b4d665d082247960d968ca9366dd67c2b469fab2d5f451eee33d4764103e77ac902db5bcc302c41d2f12988eb304b88399de5afff9e6402bdf2de7fdd70be20dcb71933e69898c40fe76e469059fbffde9cd7929417f4054f91e52ebad68b74dd4f13f5dd25ffb3895c73d0b8b565b93f66122ef7c35e2534cd9f7d9aca5398c98ab50d395d4732d6377a61e4a52ee99220fb1349a99d8f607d78349a5d615f4857c31ed7a80b4dd5cb7e6e3276e3b9a014c229476391046675d05de965395c39da6f0231d8d9c36f3ef8ffa7967ad169c8fda1483f8609d48a22f893d271698b0d67e12edb22c8676b45e744f3db5ecf34e6621a00bdecc2bc24c64d7097f85791808a086ec357b65a7d24ac34b9eab4dc2f2e261883c469228c6334c08775a164d7ca76878bdfbf364a72387b1e292a3aec03fde54c9a9769a637650128bb39ca94529283434aafbff424774da82efd0522abb8f95353bfbea22721143827381947dc2c1a0893857f61e3169783fe46bbf843744a20b42282e605d37c2cec00581765d5a96309c3cf04475c2069e3418893be428ac90f9ded721db5e78d09108e8f9467dadc1c1b03bc1c09a717cbd6f08c5df2dbed59866e39ae4bf02e98b223f4ed13b688793f9f3b025daf2e1cd77edde2f5627786ce50cc0a4833498e6ce1c341e9d21c84532579b59c232ab1fd483ed96f1a9929e8719362554a8fb05cd91312ed3c6228abc99b44d8e3d1b351639fc3d17473e5ac3c97284f748ff569a04e9ce9d94e0dd8c6edaf4929c2ad5e15c72f88a89ae4a705b1ce0590ea2f79d5ec5bdd78c786dd7d9ca4d9247fc6cc26ba40adf516b368da2308294e2c53aa4df2571c6a3807548c82236f9cec0d927beefcfadf12bd1302dd50185a5a7f1e8f949f5637c8db79001c813aa8219c890b5f715087ab547642628aefde3c72cba0920bd40581f139d9dac6e5bec00f52d22c7427fcd4ffe1051ca194d40e438c819280bfa94ea1002116f1435fb2e40b1424ddd737e0f6ce894c01399ef1f610f4f0ec2363c3867930b7ab183ab3d06d9a15651ee80deb8bb7df335e7903b09023ceb670961cf975a25efd4c58ead3a5f88eaefa9792175e594b96050cb93ad72ee9f56d9f8b30bfd390dc565995265ae8c3c63a12418c21258b1dfdf9a52b27c83cfda92923c3d4ed6b3b5a761f6ab2a2bf2a4617c2cd39000d12eb795784c87624db8a8d344151e2afa7f54b4dc6f586e409071e5dd1e352eec48fe4508ccb76ffea21ae08eca308361703c2cccbed58c8733db0e454dbdc2ab1b5301cf02683a72203f1e710fff0f53290b3a401c917f60ef5401d43ade09d57f32d4a2c079704cc21b255835d18778ae0b5f9707d5ce58b1d98c91f9953bee8fb902b59b5b1fac819a96965d13582ed7ed3b9dcaeaa665dd29ab904d960e988819a25596c2029769b7b2542da46104b2491b17d00fa7c9c18c565b944c8fc231a591a4ee9e309b50d17ed007f9a772feac4d27119197105769f4d5fb4def1c39fb3ea57f82088a37b4039da4d1ead2fa5eeae7d30a7b7f4e4784363428cd2edd855fc32fa825ebbc1c8d9d9a27e82f05c09ba2e533a33a58f5f216a983e254b21a58a0c470f8d526c59d94c85fb6e0ff40bb241035e5161503a105653147ee80e5f5792d78d6e4a6c6081d384d54c75c8683ed68620f889738827a6f7557dca4297ad5a7997cc0e87da43d4d793c80f1875cd2c32aa486a0477b5b6135626d295635b2207accba490bf6e14d1cdae7d58041a3816fd84cf7d9dbe81d5d2814c392ee54887d2a385f4ffdcce9ca77f6d7199be6d8a9de8f8df5732aee0f111b88340a2e2d265a11306060adf8dc996ff2f5c962e1cd12bc67161cd2efc0b964bbf351e9f9a48818cfb6b1141d788534f9e633355edcf3357e082ee9139056f4b8d849a7161b96b80a8f43fdfb66a4661ffaa91cbf174b4b7843f8ff27d81fba8d9b363a01e707fbda1b0329c23fb9436aad71e2b2befd06d4373376fb28d7b378d755cc9c8d6c12638b0dd77a844301b52a4201043f911679361c5cbe62140524961c58b53012a5e3b83a20c6a335de0c4a790acdd04fd18d53e726dbded093b45c66974f35a6862c2b6800ccfa1ee0febd5cd3e949e8177c9663e405129d444161981c37c8a537f61b5a0a97d7f0a9059145f2ea0197ecc0b8acd38c6f87e62e4369cc521255bdc85dcd9941de74f57ef564e373beb6272c5b676a88f7a06803c467e6e6a094cbc773511c66dfb6f39e2dbc8c24ba7a584ddad67b5e402040ee264333522cfeb37dc62dddf1d27937c2479280a909a3574c2e17c181d93c3a3a8d701fb989cb06724deca5a73cc68cf37b5cb7603bece3a8481df33e365c735c58230218b827cc4122c35f79cc87951df0a05ab226b5e81b0705a08f942782f69919df6c13dbc568bfdc494777bbdf8938855765702475af94ee42ca489f8b9e05e0e7b312d83a14d2eca43875c2bb5cc5932eed783f1fea5ad200a257ec97cf4ce67a3212ba6c22ed559173b596ec0232dcd38986b276dd62f5370fd600d66502b61049f35a5d23f73dfe85dfa2d0923d3efb50c307a9b677a3c97f29e83452781ca0a2b094a1c2c0b7442b50781bbbc65dc761aa7af7574c3fdfa07169992258edf6c417f03d27b943cd5a1553289d2194cee176ddba3e13d16754f52704d766f5c2ab25505c69e44ea5a83c8e13d33a668678cb4379a02e298f0de9bd7f0e7fad2a996f0ea82c1edbc01461f8622679b666b3ed696854587444a2545bf135695ddbfe27dd21d1a083f9d0af6eb5960471da7275de268d7e8933131c92c5c5f0760747e3520123f09ed2a23a1fe9b492401eb836ad8b91b16cf5666b5d91ba06e5ea6cc299d79e60e1d6dab60dc70ac8316c353ea744f40eb15aedd267109da7e211e1435621981812f7eb28c746637cc48564db06ca4edd30a9a5f1c5a17264c61a2089307b6118114132fe85a788251d06680529126dc488321794fdb699f30e7728dfe3730753b644d9007c8b59acd18363be21b10219a00f54305a2c12b12bb10b2abb27163cd1dbca94797bb62d064e2c2581d0d19d2d8f6538dd5486decf59ec4535b05cecfd55b8a192d5cca81cae25c33423906a5facd55681b4effae36c0dd152854a119d6be016b0784dd8919ecbb1bcaf71592c9e5263b25cbddf7e20c938e1b1e51b1462ffb738783f3beee5e3959b161c364b84381881b1473dd49ea71036cf3a69ee96363baae01d772bfaa39fbff49c90a8d6fcb25a2de1771165f7a29a9544579135bc95f86225fd0c5e87d228bb149647c6443ae19d1542e69cf476ee8410988c6776de146461c2a9c1994ddf20b4e3f89e9c76df9bc3a060fc34246ffde37e3bce7c6b120cc712bccb83c028624da822ed2bb881938df41ae679b4d0b10cace908474285e6fdd2afba21aee1e72a4c91aa833786c56d9f7a509eaca664d9725debaed1f230959b6c84e5d2b7895ad1a78e4179c40f84f371e492a7e9aea22f46d99419c8c365fa91129dabfb7923b41f80e5cc4fa1b1d9b43a1621df7a93e62c78681644061d7527a9d68b6ba338dd2f4f771aa9c09b9e494c2677005f54fb8588c6db75dc67d26f8da788d6ebbc7ad34e409e422d12eab8b541cc3739308ab634f0a660465563bf20bc44d1ed88694ef9c70e8fc811ee0a608d2da4cb99c1cce9a2434f6b9d1564e22693baded2185aa9112df4c530fe2a4d82578fba78f0644783edce72c86e5f13672f3e3a5882afeac33951c2616baa5a2005246c056a757d7a6f94e4cfffebc422907efd458dd99dc62e95dd0c487e3790e1d76726a12ffdf109b5bb2b6786a845d09725edc7157994ea2f4cb3ed3037eb5f0216cb6798ec1f14a16c9800d56003f726b6faf062767040b672acbb81a736d0180cf6ee482e610b9dace438397b19b8a34d1aa118d05b7e6b0ab7a4ae136e7a327e3b193f03e0578e8a704f1a54e055c1c637884ef00befaf7a5a3cbabdc1b64cd71ad5111401ca0db58ec2495d8a3f4145c9a527b65fc694d7db489523e1c42604c7d20be4281924005a1a1d4fba1d8934921b6fc470e988819f4ec0752d50d4ba2753194379ce6f4c2409acfb62b9a6feb5b8146dfb3f3fa145f73295b86dc381538a314dc64fb6f775d9a5768ff7e76ac17663105c2bb8a1fc7b61f186954a7a8395fb22fc1d19bb2a6fac68a4371541e220c4a8fd9b419985d39edeab4eca802d344bd56476518879afa2bc3ec475f2a48a7c0bfa780a5bf3193017b59b2d6aefd14e2c0dff8cd20587ac168afd89dfd2329811dee040ad6e04014a6c8b9339a46340d8c9fb37d8e4ef61750d96dbb4a8a5e4ddf8d6da78140ed66979c288bdfa72f8da9de0f3f2ab06499201b76679bc78b8b1f90c67c83d0615006020140831ece0efcf3927cccdca65ecd6285cdea6c60f2c358ab1898a50a7a5d67c8d8410f104cbb60fd7111af98a01dbcc1218b1521bc24b4cc2dfa01699747c48b3dbc2931579ed4789b1e0af610a8d703607c5d98040d0ee0a7fd962de7064b733d772ae3660301df821671e15bd7808c3554f66737dd0bacd29627fd8d8de8588d8b6bcf5e5ec65078b106205ad6bd8330bf1cb75cc8c70a34099536cfd698f3efa13d7ffd81483a16d8ebfa69dc32758510f6d3759aac0b79edd1ecc7b867bef1ad4e1cc980ef0c3ab254285a150c2ca8d620deee47b9e1eaebf1f7fd17697789bee0354f577780b1d4d9f1fb3b4d5d8badd1e0eb6a6f7f899aabed2a2f51f20000000000000000000000000000000000000000000000000004070f151f272e32")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
	// Binary representation
	{
		have, err := signedEip2718Tx.MarshalBinary()
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := common.FromHex("02f91c3a010380018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c0b90a2001727d783cc48b50060e8d3cf86eb8f37a5fe0dd49beb6c79e77aa4243aed4acdc5bed459f9ce1aaee191558c4791a698778f22ae0b670dbc963f9dff974c5c4c7bdf86504364cd48ecbd37c990758e92abc82f9ab42eefac09b5c307064540751421eff33e436f05f59c0a43a3c1b93442fb8b75bc4ca7156310162c935c50dfea28b8f8cb3409edb3a3b8242ddc9320f97e2e9f3d50f4428d791d7969e412ba10a2b22c6229395dd86f86261104f3cf37617d370d28f484b2605828f03b017d898baf4b4631212baef96e81c017dab349d8189a70f07bfe86240d5f5a33802ca794072aef09b4171b153af2b33a8b375a113438d271cb0fe625d76e8fcca390dcbb924abf7ac9bc5e6ea6ec38cc7b4fb38ac22ded5d9280260c53f87186e8a1f44eeca54fd915015daeaa57fa3493130dbc0e3b664df05bce6cfbe8c10c1a7b7963ec5d9f6e044995050bc169b62de61e37e91eb83e0f21aa11018edd4f2587b2c907e1f99fc93a30935a9a16c828e778acb8d04e70e6a4cf248a1f23088fcde603ae156e538c1f2cc07e959f1a0d5d8771ee207284edc9e5f34785f708a9f1395cdbbd17fdfaa0792d9ffa1af4dec2907b603698bc71621df7e34c6adf001951252b97d69590d7cbf7a102734aca33b3a337ce3deec222f2b8b61c45ad189a75dd30746ec7c9700fccf361b94b23564c974bd024b89a52d3f225d0b562e4500b51e0c447caeff5eb760d781c416aabf702c079baad87fdb18c61d50cc8827e407fe088a8da4575a92e13093d24c63ff37ac70bb2a6be9631891b0dd570a7fbb73bb66d489058ac89c46db31576a38dbe2a206a31f48751b45e1bf7934fd8fc2d242273aa1261ca679a6ce693a458a5a33d47d8b7a8aa61f62060424bcf911f147206c475842c16dd801e4ac32a8223215ad3a4e59deb4df0597a612c330af5a787f05327cc5cac9e8a9d151adfb0413b5a68f124d9f1cbe753137061f5beb8ec2b9be66ea23076f2d6da6624a983f76ad92235315a3883c2a321b013586c055941514d3a6d448ff1d6cef057e4ca26b944d44086f4df7970371464c56151221cb808f0e00818cd0ffa916b78e696132ccc71a795949a39f2a5a6acff20998c085e640c901f251998d15d6cb7092dc48e69284e4836e634db47664f926697055252be841a5a79603f8a2a419650a6f1ad7c6bdb11a391bdea76f4f68be08922f5ef08bff8c0d02d5aded7907642cc6cca4fd594f0fe4700efd15827ae2f4a9c7f8f629498f1992e4cb575ed9bedb1927bd57bde751624a34c8438892ac114cbe1aac962cf4fe199d2ff2a23cb1f8c3a3e6d78a8b44b66d8f25c3702bebbfb1974698ac701d263561a32cec56574e1eb9f289fac40fa441296d79ae4f0f51c8e9a50d7acc1779b5a47a806c692a1c49e99fafb63d2149eeb175aa7ef584cbb5504211fbe6585e30ba0edbb717decc3494ee984d5f3e56089f14ce7222c6573833377881a861fd763e4fb667c9e76c860ffdee0771465f5a37aad543e3fa5f024996dba344f6a1c24b245a45adc6a18ac4dd08bb0307910724007e344ad302b534dcf7dd2ac3966bd3668486ba361ac1390155c0e1334d3a79c631f889bb26dda72449129d4441e795f2c124cde229d4daf79bc9f15c562fc0f6faa47f6b757cf4c7d0d6271c1e47f3d01ac02938eef495ca61e051617f32693a17abacf604722025f72660979716407f15d56a71b1427019b2b8897a7991f6d9bead653b537670bf4c5e7bc54b8745b533ab4bb96b588bdeb2b4f713f25477688737dde64107d82feabc00a2689f27b1b58161b6281d9edd647b8d23e9442f2123c93365f6805cf903b8a802a2de6d5622407cb9d88512fcc9ba9f18c90cfaa80e1e9f985e9849c8b91d9cdc1f862135f6583aed4f5471124408a89081c0e14789ce8f2444dee55f789387e6e48e6212fd271a1e3a55de0c1e122c8772dc32d1ca77284eb4649e86ae6e5569a4cf840166970a21d79c50a8fc9b2d1c144ee79885ffdbc22737b03a110b3522ea5c26ae99f950aec20411cd1c2466df4d90c3ffe2ed9116b6c23a63299f6d7bbcf2a37368765d170297d900ca346fa60f0e6a3fccf2a01548219982c5e49444771e64619089da4c6263df7ac2693d9037800f68607a34d7eeb489b1a93030488d7cd407f4f2ab561701d884d7eeea39f79cf2f25c4da089f34ea3f3dc15da1bc43da8e7c12d1e0c05b107f10da1ea5a684331f2ecb696734b47407dc51a15ab9c9b98f31a42cb2e771696ab39378bbcfec21021bc42ffb1488920229589505bb6fc771edddb1818a081a5b8fc90eefba70091ea3fed3fe81f95f721570662eed03cfd759fb064e2401e634072557f025cce8affff8c062381b5e0291fb016292b5403848b419037d9bb6190045eb19454c2ea2debec95eb9d7f76f9546c922f96d1a04c537594ef5d26b226821a3527cebd56ac950c54e7fa0557e017e9a5974ae7defbe1fb3ba3037f89d12ea7f85253ef885af0da7b1e60a8637d1197b795a9d663723b94f1806b2938b5da325877d7b85ec544bbf311f75cb7e17999518cb473a5cb7875ba4e59a904cc09992313ee3f44890498af5443d983a4ad2669fee3c47d592e788c56419b1e93bdaa5434ce895506adde41e75f89dce82e6fc78cf0b85850808037c172d5a44848525d1f06cc7f3610adf434ae21c1313c438eaf9b0cd4d18d4f402279a7db469080ee807630b0388046551ca3476914e3a2a2abc0b7fc211fc17a48c0b42800406738dce93b19a64dcc3cb93435ec117462ddcfd396daf99acd0bf2037a21fce0a46dbbfd974121669287f409a778b538f862eade58da183e9bd37c763a16f56b15d8d0c8ab6326189ca7116c587b87659ae82be17639362ecaa78f7ad346ae82a8f85bdf0ddc38054b9239ce975ee723ffc854ae4d028c20dae5d7cbd1b110dd749049c89878f797a20fc15ea9f6839c130253d4fa6d506fecd3605a8dfa35b13ff61e2f9d865224df588cf8d51d00341b8c607b64158903c171d76e7b303d0d1349374f6f06f080db74f55ecbbf8a038cc209bc4d86d63d9c8b7309a423b29048abdfb8849196bdea7a2a55a9b6f3c4e8019cc80bde6e6ddff2bac293c50f4f739a21331495b960a242d2d126832283f09a9d0ef145ca9cd5b513c7d72e2670717709e169e03d4d618ba6c319ac03a4c65cf7cdd050745f0ce0f7872fff4640741284ee26f1585e05978e53e1fff5a89322e9b770bc29c697e9843157f9f797f37ed45f9992e333d780fb71ea992624c195d0e8dc008877a5adaa89d8aef5b6533c2481208a946a5b32f3c95e4e518fc1c2e76bbceee2ce18703ce38e86cc09bdfda8b90c0beb6a7ce0321f9f8acd27f93800cc79dfd671825974516554e68ed1953a80d9e1a51717f06e2392612843eb73783eb74d1db18ee8c56929ac41bec655957cccf68ab3810cfb099aea1a1d7e064afe0b248d60d8aca916bc5529555ad94af922481f535f60a060ec63b887b183378355a827dc0da8a87fef209dd79ad207c482423f2d45fd4e4e8019122afe9bf5e4fac379567c13f44c35061fbdab4939f429354f4841cb1f15ec30fd69b361596e1259edb9f506a80dcd5a17786f4eb8e35fc1556fc9fbdf18d9b911f3b7201456a97b53b63465bdd1124965603b4640c1b8c6da6613162b7a81ef2fab219947995c1764ee187e5b6da7dde582efe587b2594f39ebe5da2a1f63a870d6b0f8a4f475e5c18348bc5989c68cf85cd6248e33f7d2868503afdc657eca54149208197c0bfdd0e99fdd684e2cfa156530b79860cee2ea307605a459557593d37e1896c8fe555e67be636eea94accc5bfbe25a72078186bf4529451920f3d1e7d574f45929303da672fc989e6cf68fc4fe6b69590b0476badfdef313aad4f617289daab28d021c18a4e5a99eff1095658114d3f43178ecca67bc1e915133a2ff5e0ec478c4c7309e98d5a08cf1e450911b572a837def3e2b2b6f925b627baa1937b6d7a783503de30368be3155c275ba420be1b54bf60f283f2fc08710cef3202d4fe8e140a525f079c68af5d26a8866e667b5882eae6487bbc269096e1a7cfe4c5317c403f19192c18517dc4b435523e9ae6e127734cf67b3684227f8d2ac2731fd4ec5e5837d2d7590e1645166336365a42356e5f589b2d5a3b71023b0b9e58b9eca14894e91e90334045783c518b2fdc4c2a821f8ec75f572f70f1f1d47acc0a16b14ede021069df12f1aa0f5c5dec3eba423a391613459c4183a93f8f201fcfebf8f6d8a39e1d7d1c0f84f266a0996599602f2732801d085425e3da02e04279f4e6a9c2cb842cd98b8d1e4474d61634f656ef5461c686a937a813c9870da18c7c9349ff437d5e8a81e8e396ab1f34c8c5ad3e46d6b22a128ed98d74a80f6df5e220112eaf72048c277e5715507ecb0edcf1cba57eaec9aac37b153484b701a0ca8114c03b1eb2e959e77420e0d256d34996cf12483ac1292ab28fd6eee3abefab5cc8cc32bd3ea91869dabccf215b10ed4f6d677bf9f81e4bdaffdfb3ad22231c9be7c2b0c3d3644ba27b5f08800a692145b33cc9d2acd376c06dd15bb6ef6fa898af54a4ed1c4d159c6c5fbc31513bb94cc5f30425f862f2920c479297931bef8e2682235882315d8134142f7f9fdaa2e1691f11af7da9d6ddfed38614088d1c6bef7f29d754262501c56610102418fbad35852bafe24eb16b771a62cae38403b5dbc9e687d152af5f76f669676d1638e2eff8d95e619006ee69dde5e5ee820ed694ef7ddd6582b87ac08d03305199c86d4e0e707d2d47dddd616cc45d7be552d0e4f40007e4b668a03e8e173466a8cab8eba12233a29987a9f117547e5d3def1659fc3520c08b37f24d6664eb9047ca034f6bf4e0bf4fa647218b0f7c8493d5380d0340a0c79664a18fd1dd0a6d6310dd0fbebf12d7b23793e13cc9d2eb5d6ea64bac4e28730b14d82d1e1ef9bb2f9ae5951caf372f0450cf565578dc8f4ede9eea4c0b24b9268ac6080f404b42bb3ea5c79e58b79d5006054cb58bc9f02ab30ac1195694e7ae29b104809e0032729b7c72b8042a8514e20d8791c2b9b1802e773d2761974b5d71cd63f9c386d7097c3bbe9aa32d55e50fba77c2a265be471dd26163744d2afe7760d81554faa9003ea4c33a2172d804061a41cda8f0f4f4e3ed88fad0e1c01b369c58455cd8686f6129f34c1f5d6d4d0bcadf0750025974181c42311824cabc4cbbefdcbcc0bba7dea0669f473a89c9296805edc01fa41d979a99eda429f1a85b490b81d95cd3b4d665d082247960d968ca9366dd67c2b469fab2d5f451eee33d4764103e77ac902db5bcc302c41d2f12988eb304b88399de5afff9e6402bdf2de7fdd70be20dcb71933e69898c40fe76e469059fbffde9cd7929417f4054f91e52ebad68b74dd4f13f5dd25ffb3895c73d0b8b565b93f66122ef7c35e2534cd9f7d9aca5398c98ab50d395d4732d6377a61e4a52ee99220fb1349a99d8f607d78349a5d615f4857c31ed7a80b4dd5cb7e6e3276e3b9a014c229476391046675d05de965395c39da6f0231d8d9c36f3ef8ffa7967ad169c8fda1483f8609d48a22f893d271698b0d67e12edb22c8676b45e744f3db5ecf34e6621a00bdecc2bc24c64d7097f85791808a086ec357b65a7d24ac34b9eab4dc2f2e261883c469228c6334c08775a164d7ca76878bdfbf364a72387b1e292a3aec03fde54c9a9769a637650128bb39ca94529283434aafbff424774da82efd0522abb8f95353bfbea22721143827381947dc2c1a0893857f61e3169783fe46bbf843744a20b42282e605d37c2cec00581765d5a96309c3cf04475c2069e3418893be428ac90f9ded721db5e78d09108e8f9467dadc1c1b03bc1c09a717cbd6f08c5df2dbed59866e39ae4bf02e98b223f4ed13b688793f9f3b025daf2e1cd77edde2f5627786ce50cc0a4833498e6ce1c341e9d21c84532579b59c232ab1fd483ed96f1a9929e8719362554a8fb05cd91312ed3c6228abc99b44d8e3d1b351639fc3d17473e5ac3c97284f748ff569a04e9ce9d94e0dd8c6edaf4929c2ad5e15c72f88a89ae4a705b1ce0590ea2f79d5ec5bdd78c786dd7d9ca4d9247fc6cc26ba40adf516b368da2308294e2c53aa4df2571c6a3807548c82236f9cec0d927beefcfadf12bd1302dd50185a5a7f1e8f949f5637c8db79001c813aa8219c890b5f715087ab547642628aefde3c72cba0920bd40581f139d9dac6e5bec00f52d22c7427fcd4ffe1051ca194d40e438c819280bfa94ea1002116f1435fb2e40b1424ddd737e0f6ce894c01399ef1f610f4f0ec2363c3867930b7ab183ab3d06d9a15651ee80deb8bb7df335e7903b09023ceb670961cf975a25efd4c58ead3a5f88eaefa9792175e594b96050cb93ad72ee9f56d9f8b30bfd390dc565995265ae8c3c63a12418c21258b1dfdf9a52b27c83cfda92923c3d4ed6b3b5a761f6ab2a2bf2a4617c2cd39000d12eb795784c87624db8a8d344151e2afa7f54b4dc6f586e409071e5dd1e352eec48fe4508ccb76ffea21ae08eca308361703c2cccbed58c8733db0e454dbdc2ab1b5301cf02683a72203f1e710fff0f53290b3a401c917f60ef5401d43ade09d57f32d4a2c079704cc21b255835d18778ae0b5f9707d5ce58b1d98c91f9953bee8fb902b59b5b1fac819a96965d13582ed7ed3b9dcaeaa665dd29ab904d960e988819a25596c2029769b7b2542da46104b2491b17d00fa7c9c18c565b944c8fc231a591a4ee9e309b50d17ed007f9a772feac4d27119197105769f4d5fb4def1c39fb3ea57f82088a37b4039da4d1ead2fa5eeae7d30a7b7f4e4784363428cd2edd855fc32fa825ebbc1c8d9d9a27e82f05c09ba2e533a33a58f5f216a983e254b21a58a0c470f8d526c59d94c85fb6e0ff40bb241035e5161503a105653147ee80e5f5792d78d6e4a6c6081d384d54c75c8683ed68620f889738827a6f7557dca4297ad5a7997cc0e87da43d4d793c80f1875cd2c32aa486a0477b5b6135626d295635b2207accba490bf6e14d1cdae7d58041a3816fd84cf7d9dbe81d5d2814c392ee54887d2a385f4ffdcce9ca77f6d7199be6d8a9de8f8df5732aee0f111b88340a2e2d265a11306060adf8dc996ff2f5c962e1cd12bc67161cd2efc0b964bbf351e9f9a48818cfb6b1141d788534f9e633355edcf3357e082ee9139056f4b8d849a7161b96b80a8f43fdfb66a4661ffaa91cbf174b4b7843f8ff27d81fba8d9b363a01e707fbda1b0329c23fb9436aad71e2b2befd06d4373376fb28d7b378d755cc9c8d6c12638b0dd77a844301b52a4201043f911679361c5cbe62140524961c58b53012a5e3b83a20c6a335de0c4a790acdd04fd18d53e726dbded093b45c66974f35a6862c2b6800ccfa1ee0febd5cd3e949e8177c9663e405129d444161981c37c8a537f61b5a0a97d7f0a9059145f2ea0197ecc0b8acd38c6f87e62e4369cc521255bdc85dcd9941de74f57ef564e373beb6272c5b676a88f7a06803c467e6e6a094cbc773511c66dfb6f39e2dbc8c24ba7a584ddad67b5e402040ee264333522cfeb37dc62dddf1d27937c2479280a909a3574c2e17c181d93c3a3a8d701fb989cb06724deca5a73cc68cf37b5cb7603bece3a8481df33e365c735c58230218b827cc4122c35f79cc87951df0a05ab226b5e81b0705a08f942782f69919df6c13dbc568bfdc494777bbdf8938855765702475af94ee42ca489f8b9e05e0e7b312d83a14d2eca43875c2bb5cc5932eed783f1fea5ad200a257ec97cf4ce67a3212ba6c22ed559173b596ec0232dcd38986b276dd62f5370fd600d66502b61049f35a5d23f73dfe85dfa2d0923d3efb50c307a9b677a3c97f29e83452781ca0a2b094a1c2c0b7442b50781bbbc65dc761aa7af7574c3fdfa07169992258edf6c417f03d27b943cd5a1553289d2194cee176ddba3e13d16754f52704d766f5c2ab25505c69e44ea5a83c8e13d33a668678cb4379a02e298f0de9bd7f0e7fad2a996f0ea82c1edbc01461f8622679b666b3ed696854587444a2545bf135695ddbfe27dd21d1a083f9d0af6eb5960471da7275de268d7e8933131c92c5c5f0760747e3520123f09ed2a23a1fe9b492401eb836ad8b91b16cf5666b5d91ba06e5ea6cc299d79e60e1d6dab60dc70ac8316c353ea744f40eb15aedd267109da7e211e1435621981812f7eb28c746637cc48564db06ca4edd30a9a5f1c5a17264c61a2089307b6118114132fe85a788251d06680529126dc488321794fdb699f30e7728dfe3730753b644d9007c8b59acd18363be21b10219a00f54305a2c12b12bb10b2abb27163cd1dbca94797bb62d064e2c2581d0d19d2d8f6538dd5486decf59ec4535b05cecfd55b8a192d5cca81cae25c33423906a5facd55681b4effae36c0dd152854a119d6be016b0784dd8919ecbb1bcaf71592c9e5263b25cbddf7e20c938e1b1e51b1462ffb738783f3beee5e3959b161c364b84381881b1473dd49ea71036cf3a69ee96363baae01d772bfaa39fbff49c90a8d6fcb25a2de1771165f7a29a9544579135bc95f86225fd0c5e87d228bb149647c6443ae19d1542e69cf476ee8410988c6776de146461c2a9c1994ddf20b4e3f89e9c76df9bc3a060fc34246ffde37e3bce7c6b120cc712bccb83c028624da822ed2bb881938df41ae679b4d0b10cace908474285e6fdd2afba21aee1e72a4c91aa833786c56d9f7a509eaca664d9725debaed1f230959b6c84e5d2b7895ad1a78e4179c40f84f371e492a7e9aea22f46d99419c8c365fa91129dabfb7923b41f80e5cc4fa1b1d9b43a1621df7a93e62c78681644061d7527a9d68b6ba338dd2f4f771aa9c09b9e494c2677005f54fb8588c6db75dc67d26f8da788d6ebbc7ad34e409e422d12eab8b541cc3739308ab634f0a660465563bf20bc44d1ed88694ef9c70e8fc811ee0a608d2da4cb99c1cce9a2434f6b9d1564e22693baded2185aa9112df4c530fe2a4d82578fba78f0644783edce72c86e5f13672f3e3a5882afeac33951c2616baa5a2005246c056a757d7a6f94e4cfffebc422907efd458dd99dc62e95dd0c487e3790e1d76726a12ffdf109b5bb2b6786a845d09725edc7157994ea2f4cb3ed3037eb5f0216cb6798ec1f14a16c9800d56003f726b6faf062767040b672acbb81a736d0180cf6ee482e610b9dace438397b19b8a34d1aa118d05b7e6b0ab7a4ae136e7a327e3b193f03e0578e8a704f1a54e055c1c637884ef00befaf7a5a3cbabdc1b64cd71ad5111401ca0db58ec2495d8a3f4145c9a527b65fc694d7db489523e1c42604c7d20be4281924005a1a1d4fba1d8934921b6fc470e988819f4ec0752d50d4ba2753194379ce6f4c2409acfb62b9a6feb5b8146dfb3f3fa145f73295b86dc381538a314dc64fb6f775d9a5768ff7e76ac17663105c2bb8a1fc7b61f186954a7a8395fb22fc1d19bb2a6fac68a4371541e220c4a8fd9b419985d39edeab4eca802d344bd56476518879afa2bc3ec475f2a48a7c0bfa780a5bf3193017b59b2d6aefd14e2c0dff8cd20587ac168afd89dfd2329811dee040ad6e04014a6c8b9339a46340d8c9fb37d8e4ef61750d96dbb4a8a5e4ddf8d6da78140ed66979c288bdfa72f8da9de0f3f2ab06499201b76679bc78b8b1f90c67c83d0615006020140831ece0efcf3927cccdca65ecd6285cdea6c60f2c358ab1898a50a7a5d67c8d8410f104cbb60fd7111af98a01dbcc1218b1521bc24b4cc2dfa01699747c48b3dbc2931579ed4789b1e0af610a8d703607c5d98040d0ee0a7fd962de7064b733d772ae3660301df821671e15bd7808c3554f66737dd0bacd29627fd8d8de8588d8b6bcf5e5ec65078b106205ad6bd8330bf1cb75cc8c70a34099536cfd698f3efa13d7ffd81483a16d8ebfa69dc32758510f6d3759aac0b79edd1ecc7b867bef1ad4e1cc980ef0c3ab254285a150c2ca8d620deee47b9e1eaebf1f7fd17697789bee0354f577780b1d4d9f1fb3b4d5d8badd1e0eb6a6f7f899aabed2a2f51f20000000000000000000000000000000000000000000000000004070f151f272e32")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
}

func decodeTx(data []byte) (*Transaction, error) {
	var tx Transaction
	t, err := &tx, rlp.Decode(bytes.NewReader(data), &tx)
	return t, err
}

func defaultTestKey() (*dilithium.Dilithium, common.Address) {
	key, _ := pqcrypto.HexToDilithium("45a915e4d060149eb4365960e6a7a45f334393093061116b197e3240065ff2d8")
	addr := key.GetAddress()
	return key, addr
}

func TestRecipientEmpty(t *testing.T) {
	_, addr := defaultTestKey()
	tx, err := decodeTx(common.Hex2Bytes("b91c2a02f91c26010380018261a8800a825544c0b90a207d87de68b6a9e476785e8444c253e78b0ca3ef9413dbc673ba62fc47bac1003421ddce3aadb4a1ffaa79d9a91e65d81bf203e5207ced88153c10020512f84c7d78ea6e97e94bdf6bb9e9b750b63fa501355e19fa319ec4024dbbde5dda6d011eed6ce3b14efe488d9b8b3b782231a63e7fdd7b22e433dac65e49ac2e2e3c10a54ce384887a03b98759701fa84cd7ba9d1e1dd90309bc693c5fb8a894c8822b008f3b0f01f560fb011a6e024b6117cbc5eac6de111da5066797afe8145a62766b01e003554e8fc08097a5cb543c51e8c8b1f56b9c38ec7cf9517e6c0e9aee1f504ccad2dce8f801cf9a0b9150d7f6b225d14369f80c1fcee36276f1a0ca108d8ff1687bfaf95266b866c7036430db7900bb50cfe11743180643069df2b278e530ee5f797fd83d8c45fc86eed5d43f6e8c03856f407eb6064dc2d43d45c81c445760584d62c54f201b788aadf5b1ab995e2441413313f7f851ef29baba8f941023c008bbdec58de8b8d60eab199d0ec1e868997ce13d54212e3908fd287f91f6c141fd086d21d5029edbc10d4b52257b25b8a4badb5db366a9284a36788c01f76d95cd34f1d638e90102aa9d0d38a5b555d38e48972d12b099bdcc5daa5262c639e023470306ca8e9d3309e977de9eab71f60d404511335ff158d161e05028e8ea02f834415d95d9951e1d9f06f5b57c25072de43990f06b53ad4df7e9c9279e68326459016f8117aeee35658154607c3c981a76b87c4e75d12d96f877f3b7f47536d1720acb9333db1f76437d8dec247c80528b7ed7e8af92e103c3eb5aa3ba81ce56c23932317a9c8eade68c0342373887f803fc87a667b587dc476aa59086a3045219fe2f7c611a8666215e348177cbe7ca45da8b07ae1842cca020ce7013e83e138efb62eeff88c7e2fb76a1a957d1f02d26d63003c4db6bd4ad6174db1e0502121a899587a0aa049a77a5387569794e414bebeae02295efacfb43b02b94e0268e44c9cfe2f14edfc9058a158aa4dae58b23dd96a915f8942d5b51f81fdc1e45b1985b8f717d84145611f676e3712f5406d7095d8c3d2ebfe17a722d55907e64bba4ee5514fe70071ac03e4f5afaf049a0f24a42cd3a5c68a509a157ac1af2d28864dc66302103c21c52dbd9e6f6f8487d637cd2f3279a2a6fd6b172ef0280768061b0718621dfc0af37f7079fc400e4594d01243c2158fc318dfb5fb9bd3036a4dfa1b52e551a639468b75940028c32accf4d6fef6dc2d9efbe88b4899f9384407bf0cd50d92bed94a14c40d5ae3076ff6284bf214b4b177db663aef6d9ff5ab394bc985f3bdea1e0beace1f5fa0230cf53e57473f50a6610a677a1281d9676001f214bc3cf0987a82424e87e0e7e5237606e60e71f3a92400ac95c0c660015e1b9324aa4b1231c138b35195add8dc4002c26648bc5707c7537623d046281c5597385a87d5bd92060ee6ddc3efa34daf49ffac27cf7a48697f7a1a00ad3cc2d9ee66e67786763ccb086e15cb6d9c868f6072f7d9b6970cadeb1773700c54d2f197e5cc6c6a89d1823fedb207d0b49efc8158f3592efce23046774b03673fb88911af0735c185b94a5f44edee34cc99d1d064808c119bb6a4c90635206b0f440beb519721eadb4df66458655ef3cc4033d7ae8aa0cbf7b7b8f6ae8321a5c26d4964fb01d331ffec57a93a017f0322fea991a93b7e988aea9fd763365b6f4596623ea49692e76bf5dc405de914c14612348076d93bc0a83286974a9a615edfe2da2a7e4f60e15a088b0550afd4aea994d00bc88c20c0cfee38aa57d67736ea2f59698a02ec7174fb5d42e9c6f7520e30b2c386fca2b8fe9ba1e6e79a42a3586670f16ae2138c12ece2e35c74bc0ea4d6199c818f58cb7b4d12419b4af016eb73e60128b70d6092ada8aa8cf2c419208ec39e5cad3ea99f497682d4991b7bc28a2dfb987ef4a72ace24903d7ab72c5c9dfca68179c95165bff6c77558edd55adea46b191763b0b0ee33cfd5ba61a04b425a463230a8297ce46d18e5825c740e8ec1bf56d2cbfa639eb904465f9dc67757eeedc83d61c1684aa67609465a295aead7da61ae97287e7f26e5c541fe932a972c4ab600b4ebd96b55e6a4de291e7d0e8135b9ad1c6283e12d0398f5f2a608a4e56a4955cda77ecc0f8f0fdebad91e65c763bd24f8459e761290974d8ec5ec43974cc89dee08329b8a62d71c411a3d3bd738cd14ac72dceb69d59c33ad974dff0b2cdc6b7cb092c48091c65d4f380288f2a1c3ff643f836447f0e094e12e1d0fed622afce581bb128454efdcfe61dd3767c8d5651ee3cbf79478c467e113866026241b31f5c570abb06ac723bd71d97332cacdd2203951418513f1215fd6fbd4210992087e12558b78fc8a5a921ecff8bacc9ef43f7992be7549207db7261df8a7cd04e18f2cea3e0157a9773cbb6b5d5bfe76ebd6d2141c9ce293e88ea821ef2054a749cf078d1c3b5214b336f883384dd9e4c91113410324051b95d1215de8e552f52e6a3045eec54b725af1a9e884f0ef8ed549e72f54e641e5841d1150eed9bb94be65c3462e02121330acf3f7f0e506f9951fea984fa936eb77e366e4f0e0fc456175c3e81451489cdd8d2f8d7c82ae84cd1805fc8673b1550b736cca2a321b79e185e9b39161b415e670af5f7073dccc4e81387d2eb317aa3a68634191ed4e3791dc0b23a4ac20b0d037224ecd142dd4e69fb2a85911dd9cc6165d4ceef7c24347d1215d4cf4de9ccc04578a6923c589b11604e35abcb553d9a3a62a42e5024a9f6cf1028e5255b957bf1e179812be14100d7cef389a6476ce90a07823f8eef6cde33bf8812bfd89bfc16505150335d715f6c77f50960d529781d965f504da192d6fb503a929641495c2c9d18d8879d33a00640ecfe1611ef0e84d36feb4f0d9276376358046c9edaee456af4ca934c0ca1e95ef657fbf2df2e30c722903e4c76a9c44a6860e6d4c23150a822850c61146e3c2334ba9c793620f95063462dca4028556ce81dec2c24d00b1230b2065100def043b37c2b951a3cb2b32220438f45d1058d396f55a87993ea1b1cc0b4aa9c85ff3182879f3a88c076f455c68e042089b6d35f9b5f99290660cbe249bdf20639282dc7b6d9fc2cccdb0db76134cf0fb932b20a50afe37814a5f76e8be39211603573fbf34be3d8a234bd03a93a8afc41e91b1fc9f51622ea90dbb28dbc64a7f3bdb594f75d9fbc6ea98d50d2df4f2cc28bee17d41174bb0392cab1183c95b747562578eb131042a2d67532fbdc1b0154fc20f7d9337e2ce6f68fb859783f9f27b66af00637b12d37ba40e0afa527b7e61ae878fb131a5452082e72201fadb36f1e24ce5ed087ccbad519a0745185bff4890e5daf135d32d9aa0c340fd7ceed1ada1d47fa8a737de0e47009fbbf717c3c471fe11283b694b687540891da1b9728a5b6deee6481e680521f498d6162093bc03d6ff2ec4f6e80ba086f4909e6a7b9a2c5e59a0d9edabf3056c5b77c87371cde641e6126d588e4aa7929b76b6839e88f97afea1384dadc718b61b314939287ff1f6ec24017a233678b2f64dc65ce08b4b12e6f0f922393ec0d1c7962c5aa881fffe6a95275ec8cd4230f5303fa2ea3f9eefad704777dd2be4f398848622d21c8b6c3ba5050b3768e5bdfb911f310b51aa333dfa7ff379252a1b1cf769ce39750dae6003de462ed117fc6c0ce9ff184bc839a41d371579020a2d47ef2cad499c3d2ae9d56b9303cb8767a87b7037a34056934956f54947ca59f4aac8797be3a23933a712271f3b8c6e71396e22741076529bed57abbd7da44af436971283486668613e9cedb1f012ebd34a21a60dea8f9e04ad207db9b77466918d994e7768058eba39bdc4e82eb4096dd73367ee0c196a958d1ab9762ba78ec15af29b40a6d5b7f6e99fc024d8cd923e1c46dd4466a622272e8e0ecdff05943f05e937567ecfb77704bc15e39e8bbbb4ad117c084e24cccc933093e29f0214a0f03ca33fadfadb7183d095c0af3ad5546abbf7c1f6b314fb201f492fe86b13fb2b5553826b2aee40310c6bcb40866b9e7337c3d186f757f4f2b14b6102d3126ba11cec96167493777e3ffa8cddd66ed7e625bb9e958bb212df1956dbfb8ae078d4b8f7b7a98b49f7f3d43e81e401da2515f0d9feb34a1323643b547d9fa530e6e3a693454e93b70bf8aafad853c65b616311997f9c1a3a8b1a76f9e0ebdd51b39740236dad4adb0f9cdae6377ba8add49e781e9a7393bd72e0f5a12663ce15d65271d20c33ecb74bd4793c8bc99c4c02c1f6c3fcde13be276f182d0bc5c079dfb20eaecae53bc9e51190041e5d1cc4f31a8539b62c1555225c513caf82530a9435591ac6cb408293df3ee3cb39b15f96d838e04a6ab77d68c1f87706497738d2db35fb7d5b4d95ec111df41c2b278ff66570df2a63c3a769528bd9a3d685175b5d5b6ed8ba9b0cb805263415a736155f3b7e63a4b079ffe2d986ecf01e65a98adf02d6c64458ff4f6b0a366df9fe3b54e5a8fb387423e45935bf01374dacdb3297c701748109e4ae50d4662db530503f592ce611310c5a29b318c4a523a1685ed2b2bace0dd7092a03c5202593212c3a581e34c0fa5384f07f15b3c945a24f10afc0fef61b3a4448b8a133264ab5e414d05a9d35f84a698da98764031899078f21e28570f53e4536740ae7df8abb234d54615dfef727483c94357c8ea78a7d18ba78290f4ec30db559cc9a34fa5ca146321aec166db4ba77f39b6998ee92a647dc1a91f64374f5bae758e921358e61f1d98272a82226db9f11d50961a1fdcc7cfe4abcacffedce1632508ae741b273183f556e2192378606b520433317ecc9dc2c5c37278152ad69685f7456aee2127113dbd2baba308725b46d373b2137d13fa42af463d8cbad93ff76b92f5bde85256242c7bc060bbfc5c19ca77948cbe74277c9ddaf9f669d032b250b368959966f813bcb2381cf74dad1bf87c8acb65d4e6d49cacf1d9cbe35a330085fe8d9dc04d74e1fd229120aac3372af8705f0810913d3ce92268ac677c41334ab489ad93372c3d8ddaccc95892e2d377a9ee3b72ef524fc30385c6925ee3d9d891ee92c6eb017aa32dc38a3b8dc76e3335f576ec30da9143e683655ae14b372b2f3e9ef34bbc28295972bfda990a088a146e0f454937842f403cb52c90c1ff76472c1ec8b0e555099008af5c49da26aa71d779a10f64f576f4e7fc65b6f59bce1926f180416723a6ad9c7e2e4178f820259bdf00e26ae970f7ba9ba269b636a42b81313fbf1a7989346e564176f0d619f44be16d001b12f7383a51b400cbd756b3b48add638002f957a8bd54462617bcd68306e86ed6deb6fdce5b65bd95a58c4d84e332dedade54839c67522d7c47b6512bf9b4fab3fd936373eed134dafa31a3457ef2449756f73cdd825c42f787ee12d313b9633da329aafb7cfbef68b0db15b3afd9e6bf32cc0198a5bf7424738f636e3246e9c57d10de021b1d750e1360450b80421b66f28a1b0211837daef2196feccaf2a797754dd880a997ed6124746664bfaa9012ce81fbb7e988dbce9a06adb046f003721f4320a3c0a01d2cb4b55da7843c78274bd3753bce2a76feee7684c4821ba88e871735fe38b1147a4f0e0fead454f4bc7b73d04fd18880adeb879c1301f4073e62029220ca05ca3d5b71a462c14f63d5e8b6e54095f085b980000bf7f9989db16301a433a8a5c42737edd7b4817603f30d0a6d490e9c5e852eaafe75658c5b7e7928bc454c89dbfd25b3f869ba56a15a509f4a61f55e9c73b35d07c174c7dab6cc298c820dff6b2e9a2a69c852797065d5e5298d364d27c9a4ddf0ccd6fd7ea34d34612521ab554ad41302ce46c2d9698b84b893094aeda3ccb76aabfc7cd0d1aedb5de75fb2fbcefef260a22c937259eb29d4d42f6b2a8472a361d4932521bd3d53b310c91fc9f0bdeacb4ea6cdd1e4a7ce6244ed1620746b19fb0ce17552ed7166745ed086a774a3e8e517a4230e945c4a4dd650134b2ae46a0ef409c5ddf455726bafe703618cccdb8c1579a2e814e9d944fa8d8dbef86670ebc01a79e16cc08c153981af299be0859575ee27f6fd145c9e39e33c00d780db1965d23d510dcc91b0ad6c0a4a35a6a91fd8ef60e5025c42fdc39f931c062cd82ad688bab039ce3de62c2e3c573b9a80d61a7452af66289564a0f90be70a5a4aa9658e7b5cd586feabe204e3cd4aa0a99f4d44ef212bf530554047c155427e07fd9d93fc6c327192516be4861a09b1817463fc71ccb5a5d0e74249da7132488427929dbe924b4a9502350b482cee0f816810c0382d985381860db0ffe6b15c134f86802b708641a1e68642bcde0f90d8dd76b39e816e06745ff40e557d8d21916a9bff4a406643f8facc6b5d63007414745128f42f4b228fce685a7d1aeb6207b5ee60685e44a956e1e6211dcb63bc556b5d726118391e23031c6be5ec84ffcd288c1c0afe00e36f0360660bdeb2039a119bf3c36f8e7ce71fc0faae7e8520495ac0c22fab135f049405e7bf54679ee325397cf95bf1413052d745aaf71be2e62c5224ab9ac3049e6e75e6a3aff401e90fb8da4bd2bb5603a5625fa61cca2708c074c4cc28783eae79faa25ca6c668765b8391ed7ab2bfb306da3971188e557ee0b01e08b41f4dedd7e90c2bc59db9fa918bb82da4faadd9a13618afde67c0a74685a576d0eb07cba3242b4e681d80b50401a199d14be2b78bd1f3066baf115561cbd941980a4267a4bbedecaadca4f95d4ea30fa4ff7e1f6ba972f20f69d23c190029155ddba537eea9516f42678f5aa27dcabfb87a569a72c2a4abef7f36788bb6fcab20377ec95481344572c8c1321d97e16a764d0495aec84d419212de140474124ee3cfc878d42b0ba5c4cbb85b2615947968c33dfb8e73cbbe82a363ab96444190d2a3ea0b69ef199760ee4dfa80cb25231179ad77dd387fd72d1ff9f50ff1ed928d2326bc579879b578bcf0f08308a1aeb2cb033acb641cceccd46028dbc1e77f77711f94d86df2deb7b482cf7f6454ee6841df9a28a9801fc9e536d4bf6006b61b9b37d53613bee1f4225469673317983312856956a9df7ef15af4cb5f1b0841e1efd31d6af9714786c63e51099e4b6ecfcc4478301cd3d5bbf3c4bd6220e3c53767c6fa92516499a5996a2e1e9768bdac9c719c63a34f553995f054cf11ecd1158965888f017e5c1af573d110e52a60e589a57c8afffbe0d5828bf2ef261e4e615a87cd8e706f4ecf35b1f32e7fbb4cfee92c841cba1ffe8ef9fa2af3cc56fb41f8c7ce17e0543b7f9ff37e64eee1b670f25e3e8e0bfb28c3cda15d1d34b392d100226544b6da9314848bda275575ec7d959b1eca4bf596370d3581e668bcafe0b286a45d47f5d7f581d32074098feedc5c1d82a5b714642be4c72e2949379bf64a9617bc479018093598f3ef35bad63de380e62ea0565820d78b1d3ce16af9cc3e8c5f7ff8d69fb4519f31366a91587f2de4ddfcbc1bd009e426751e1e4eaacfc1d101047ae412e30d8f9e5d3e79953e22d629fe41415da8534a6567280a7494b25c42694f4e1318d86184fe4d99e5659f20181ba3170c6e3e3241480814ed203bcf1d646ba321b613638e672d329f7a60720cc0837dca9fd6318333ea15b55997c93490fbed5e77b4148115e7672f04d536effc8be4e2a03e700d0473e7d9f4791729592ef22866ce9e06457d34ef4640439c8cbd8d45b0bfc4ee2d638773f7b877ff8f8957dc22b6e2e0f60935b9e83b78989656bd6fa7e98efed335e8c7d5c53f3b81fe095d5c19dd7c2855cbe07aa2fc62c8bc08d8c88c4a2de3e4e0a2a254fbf4d056db3f26b4cdd705736871b75c4e2e988bc9af2caf2ab2d3b8f48958c883865c5fc0923620a98d608c9b6a9efaef779b67847cee066e96ecd29857d46a5d72f62788176dbaafc663da0edc866eaea7c5e3c4574baa7236867515edf529cf2b33165bff28ca7caad02dcd151debe58ffa1343f91ee034826e33efc167152939e84d98e598120878007fe6b5cf99cc1d0abec85c8471d323474d6e5c16cdd65ff7207cb9354edc3e78edd38325f3cafd91a5a937e9e1d1331d2450d22bd18eba366458e4d89e3ae3c0fd458b9dc4c7a7c63e74d8ac3d59eea14f7b173187a1b4d9ce9c6adf556407ea3a076159799d3bb124ff29f4f235c0b62cca4770fdc7726ed9c99ae84ed347e66de930fabd9b4ea343c9ca7bd462d19d794813dd29484997f86c1252e4b3b50a61f16c47eac76248ac8e005c2677eef60951a29c90eb5b4f7470c64176f36897e9fe2b3e867dda8601930e01696ab26806abd6b75839bdd64f7267ee0b49a0f45cf494aeaeb5bfab4a527edd028dfe394bb1fd97d10e193f9e911b4ab4d428ceca6aca3cd596a1b05d0d1164104e750ed326f85996be6978021c04562cde51ebce87d0bfb7b7d4f26db08801110c953395315e601157c794cc3dd14025c729bb46d1f756b8d20181cca7aab9be02269b6d4bc2a2570b8a5ffca76dad7f4dba300ad50bb13f1cf691fae6a1a4352aeeec67ace2ff40d9e21219545cdcdc87a0611025f8e282532d9a57ea713e600b838becec25b1bf1e75178e221fabedcdd84c2f641c8ec6c88f95b75fd981ba307a7a130ded08291e23224c89aa836814424fb2b05a74d173a83dcd9a311dcb68d2144edefd535cc469f033b0a69b049f18d91db6c2335e0f79d398ab861e0e6f0757e408628539acbe627f5f92943d004b3b019b578024b92fd02f95b6f903e0532a77cdf5afbac7544bb4886fd5502f0d2b6763225aee5208b03b04dbfa47cc7aab3860178ef5b0feef25ce10a57611c2fee2ee77c074e8aa25148aa32a979970b7f064e56ff8a8117836af4b7d132a0a8bcfd666ea95b6f1b016fc59009a21b8370da60532e3491195db16eb2000cfb0a48aea77db9f8583ac84841a7f3b69c1fd8f1d18c70e081393b01aef2cc76ccfa59d0352fd91fdf28b833d1ab2654a5203f74c1d0f30c105dc47a40effae8668c4178e214dd72c4114acc3d4798b5e0dae39bc40979a5999db932c5faf7606d6c1d35bf7a3ec2f9e19a1620d76e16742b5fffec1f64f0c89986350bd68abb702c26a03cadc7b4f163f18fe7d15e5beb5699a2f0d00139d7e41f9678083268a20a9e5cff6d72553d32f44444baaa1b75af7ffc6180b5b09ce9032c2af09ea6b1bcae9a00c9efe3a0afd17d6196af749c2e1d4d7d4420825e7072ac54cb135ec434165700fe378da2a549de95ded9a0d019f6599ce941672d64c39fb7a818baba48137598e713018a0a5c8f9af7d7cff922b07c6f4aa1a96721fbd84e267686bd72a2ff7cdb4945ac7d121738eb0d9fae7aa2296228c7cf8b96138b1509485f6de723c417816947cb444744e910affbff1a88483b025c6ddf90f896238994018a1c2a58622189d57b4dae07823533fb5ca1738c994d67fc428d8206de27a29b26c53181f8faf309a93b8be2d6ecb049648033fc4b4a3b6fcdb1eb0abc63b58d31b92478c26f1b466caadcfbe81ccbd492704b7b198446464ec38f25f5585d2ab1acab194362bf10e2b10d206d1574964c4094c43e0214a417fc21d93cd4c07756ed0fdc1cdc1bfed93194ad72c902d88955f12e63bdfa22dce770330206066e7837ccb06428cdcfbdc35d4748e46c404bfb9d4154bc47a6e3f853dd2e7cdde2eaa7bebb466680b15af9ccd92ddf0444ea7d9afc15e9adab9b0efebee87aadc70e83ff55f24cdff96ffcc63a4ab16a8934a1ed80b14600c402f690cb84da0f607e7cc1f28c6e0299a1d410a1376f0470b8ddc178cd04c7034c8e18988cd4f35bb2e9d52b3134cdd5d53004a3b3123a371741788bf676575b119865c50a4f0abb23f3cab4e07ebd11bd9c98d636ac4f333870ebb7d11d1d3bdc7ffb349cd83c7db6de3f8ff5de7e75edd3a56c9cc76fbcb3133354cce94b7d9cc9ee5929304e9d9beae910d8a001f9768e8618b12db016b1c4c8aed174f86f1d59be123adea03a4c527dfc7995742bc6d071578f611303b4c5697adc103224970919ca6aebcc1c8d3f3fb3f96b56b70799ccc495b679ba1abba587c8f9496a70f2c3d787f80da000000000000000000000000000000000000000000040c1a1d22292f36"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(ShanghaiSigner{ChainId: big.NewInt(1)}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

func TestRecipientNormal(t *testing.T) {
	_, addr := defaultTestKey()

	tx, err := decodeTx(common.Hex2Bytes("b91c3e02f91c3a010380018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c0b90a207d87de68b6a9e476785e8444c253e78b0ca3ef9413dbc673ba62fc47bac1003421ddce3aadb4a1ffaa79d9a91e65d81bf203e5207ced88153c10020512f84c7d78ea6e97e94bdf6bb9e9b750b63fa501355e19fa319ec4024dbbde5dda6d011eed6ce3b14efe488d9b8b3b782231a63e7fdd7b22e433dac65e49ac2e2e3c10a54ce384887a03b98759701fa84cd7ba9d1e1dd90309bc693c5fb8a894c8822b008f3b0f01f560fb011a6e024b6117cbc5eac6de111da5066797afe8145a62766b01e003554e8fc08097a5cb543c51e8c8b1f56b9c38ec7cf9517e6c0e9aee1f504ccad2dce8f801cf9a0b9150d7f6b225d14369f80c1fcee36276f1a0ca108d8ff1687bfaf95266b866c7036430db7900bb50cfe11743180643069df2b278e530ee5f797fd83d8c45fc86eed5d43f6e8c03856f407eb6064dc2d43d45c81c445760584d62c54f201b788aadf5b1ab995e2441413313f7f851ef29baba8f941023c008bbdec58de8b8d60eab199d0ec1e868997ce13d54212e3908fd287f91f6c141fd086d21d5029edbc10d4b52257b25b8a4badb5db366a9284a36788c01f76d95cd34f1d638e90102aa9d0d38a5b555d38e48972d12b099bdcc5daa5262c639e023470306ca8e9d3309e977de9eab71f60d404511335ff158d161e05028e8ea02f834415d95d9951e1d9f06f5b57c25072de43990f06b53ad4df7e9c9279e68326459016f8117aeee35658154607c3c981a76b87c4e75d12d96f877f3b7f47536d1720acb9333db1f76437d8dec247c80528b7ed7e8af92e103c3eb5aa3ba81ce56c23932317a9c8eade68c0342373887f803fc87a667b587dc476aa59086a3045219fe2f7c611a8666215e348177cbe7ca45da8b07ae1842cca020ce7013e83e138efb62eeff88c7e2fb76a1a957d1f02d26d63003c4db6bd4ad6174db1e0502121a899587a0aa049a77a5387569794e414bebeae02295efacfb43b02b94e0268e44c9cfe2f14edfc9058a158aa4dae58b23dd96a915f8942d5b51f81fdc1e45b1985b8f717d84145611f676e3712f5406d7095d8c3d2ebfe17a722d55907e64bba4ee5514fe70071ac03e4f5afaf049a0f24a42cd3a5c68a509a157ac1af2d28864dc66302103c21c52dbd9e6f6f8487d637cd2f3279a2a6fd6b172ef0280768061b0718621dfc0af37f7079fc400e4594d01243c2158fc318dfb5fb9bd3036a4dfa1b52e551a639468b75940028c32accf4d6fef6dc2d9efbe88b4899f9384407bf0cd50d92bed94a14c40d5ae3076ff6284bf214b4b177db663aef6d9ff5ab394bc985f3bdea1e0beace1f5fa0230cf53e57473f50a6610a677a1281d9676001f214bc3cf0987a82424e87e0e7e5237606e60e71f3a92400ac95c0c660015e1b9324aa4b1231c138b35195add8dc4002c26648bc5707c7537623d046281c5597385a87d5bd92060ee6ddc3efa34daf49ffac27cf7a48697f7a1a00ad3cc2d9ee66e67786763ccb086e15cb6d9c868f6072f7d9b6970cadeb1773700c54d2f197e5cc6c6a89d1823fedb207d0b49efc8158f3592efce23046774b03673fb88911af0735c185b94a5f44edee34cc99d1d064808c119bb6a4c90635206b0f440beb519721eadb4df66458655ef3cc4033d7ae8aa0cbf7b7b8f6ae8321a5c26d4964fb01d331ffec57a93a017f0322fea991a93b7e988aea9fd763365b6f4596623ea49692e76bf5dc405de914c14612348076d93bc0a83286974a9a615edfe2da2a7e4f60e15a088b0550afd4aea994d00bc88c20c0cfee38aa57d67736ea2f59698a02ec7174fb5d42e9c6f7520e30b2c386fca2b8fe9ba1e6e79a42a3586670f16ae2138c12ece2e35c74bc0ea4d6199c818f58cb7b4d12419b4af016eb73e60128b70d6092ada8aa8cf2c419208ec39e5cad3ea99f497682d4991b7bc28a2dfb987ef4a72ace24903d7ab72c5c9dfca68179c95165bff6c77558edd55adea46b191763b0b0ee33cfd5ba61a04b425a463230a8297ce46d18e5825c740e8ec1bf56d2cbfa639eb904465f9dc67757eeedc83d61c1684aa67609465a295aead7da61ae97287e7f26e5c541fe932a972c4ab600b4ebd96b55e6a4de291e7d0e8135b9ad1c6283e12d0398f5f2a608a4e56a4955cda77ecc0f8f0fdebad91e65c763bd24f8459e761290974d8ec5ec43974cc89dee08329b8a62d71c411a3d3bd738cd14ac72dceb69d59c33ad974dff0b2cdc6b7cb092c48091c65d4f380288f2a1c3ff643f836447f0e094e12e1d0fed622afce581bb128454efdcfe61dd3767c8d5651ee3cbf79478c467e113866026241b31f5c570abb06ac723bd71d97332cacdd2203951418513f1215fd6fbd4210992087e12558b78fc8a5a921ecff8bacc9ef43f7992be7549207db7261df8a7cd04e18f2cea3e0157a9773cbb6b5d5bfe76ebd6d2141c9ce293e88ea821ef2054a749cf078d1c3b5214b336f883384dd9e4c91113410324051b95d1215de8e552f52e6a3045eec54b725af1a9e884f0ef8ed549e72f54e641e5841d1150eed9bb94be65c3462e02121330acf3f7f0e506f9951fea984fa936eb77e366e4f0e0fc456175c3e81451489cdd8d2f8d7c82ae84cd1805fc8673b1550b736cca2a321b79e185e9b39161b415e670af5f7073dccc4e81387d2eb317aa3a68634191ed4e3791dc0b23a4ac20b0d037224ecd142dd4e69fb2a85911dd9cc6165d4ceef7c24347d1215d4cf4de9ccc04578a6923c589b11604e35abcb553d9a3a62a42e5024a9f6cf1028e5255b957bf1e179812be14100d7cef389a6476ce90a07823f8eef6cde33bf8812bfd89bfc16505150335d715f6c77f50960d529781d965f504da192d6fb503a929641495c2c9d18d8879d33a00640ecfe1611ef0e84d36feb4f0d9276376358046c9edaee456af4ca934c0ca1e95ef657fbf2df2e30c722903e4c76a9c44a6860e6d4c23150a822850c61146e3c2334ba9c793620f95063462dca4028556ce81dec2c24d00b1230b2065100def043b37c2b951a3cb2b32220438f45d1058d396f55a87993ea1b1cc0b4aa9c85ff3182879f3a88c076f455c68e042089b6d35f9b5f99290660cbe249bdf20639282dc7b6d9fc2cccdb0db76134cf0fb932b20a50afe37814a5f76e8be39211603573fbf34be3d8a234bd03a93a8afc41e91b1fc9f51622ea90dbb28dbc64a7f3bdb594f75d9fbc6ea98d50d2df4f2cc28bee17d41174bb0392cab1183c95b747562578eb131042a2d67532fbdc1b0154fc20f7d9337e2ce6f68fb859783f9f27b66af00637b12d37ba40e0afa527b7e61ae878fb131a5452082e72201fadb36f1e24ce5ed087ccbad519a0745185bff4890e5daf135d32d9aa0c340fd7ceed1ada1d47fa8a737de0e47009fbbf717c3c471fe11283b694b687540891da1b9728a5b6deee6481e680521f498d6162093bc03d6ff2ec4f6e80ba086f4909e6a7b9a2c5e59a0d9edabf3056c5b77c87371cde641e6126d588e4aa7929b76b6839e88f97afea1384dadc718b61b314939287ff1f6ec24017a233678b2f64dc65ce08b4b12e6f0f922393ec0d1c7962c5aa881fffe6a95275ec8cd4230f5303fa2ea3f9eefad704777dd2be4f398848622d21c8b6c3ba5050b3768e5bdfb911f3f34431a005b02801b954002b546f770217a02f7e911afcd81379368486c592e6857503dae235aef60177f88b2c603fd7cec9b2c7fc08612486e31d4777de6c5a0e9e0958019e88b46314b875a9cbfa18e33416fb0783e3d6e6ce02260db0d4215a92039b6eccd508cd5f32c76822a084b9bd1f708209f09c12761093ee9cc94675d78bc06ba1e61227d4cb5c0cd9caffdd9d1198485ef27311873173fa36db31a36e2d4cdd17021aee99c7200df53ebf168e11dcbfe9e58cf67836b37eed18e1580225d2f5dc6eb085f4e9cad4b8558f3981ad4f8de122d2f049cc8c50f2523e339bb7a4e80a11836fec6bb54686eb75456b194c2a1025486b4682c0753f32c9d01fa5e80e50aed572f11a20078dec9dc6f379d017eedd48921e892981e32d447e107cd5d9fa673a86f3488a393d910ceeccfb2cdd72079f2ead0250a54ce0c4270654e2202f63c314a9fd3ffa345348449ea2bab101b59d1bbe671a5d8278abf1a6f8fe5a447fa3bc79c7b666a7cb886cfeefc20d200e4dc2c2485ec85d185de33d816e182bb549041547b4e13373f8f9e797a4adc5f62d8446a641724e0977cae482320a72b2fdb2bcb36a0224afdaf779991e132349080461a3f1d1b03b3d1557709ad2c75edc707fc368ac8515e772c72e82ff5bfdfb585b9ee2ac06d3bdeb7e89bcaf299e2c80f5ad9248931f8971e5d9379634cf1a4141d193a403c6c3c52dab5b3a950d3144e4f02028730fc9083ef988fcaa903d5528c8a6a29eb3c8a34931521f95604e0a8c381a179bafecadf80876cfbe071bbcba1df675db4a90873a7f613be1a1b0cac58bc345f9da09b6c438903e34e9170202e40239577f3ca3a1a17b7849c10eb789a20266e44799fd0c6da8cc26ab6e03d881c5055358cfb9c94d6639b7e089ed34f7cf8b3bf2b3aa08d7fe4e5a6468cf22a446d11fb22d8fc3bb104d5138c9150d87c142f8a4432ccd5fa5b023cc174e4eccf876ad5a02d1276ccd3e600d5d69d6d6c324e45ba1e0ad7e0b4fffba85160e7de52fc0a509ac15f5ca1d78585249d570a4986adbdbc1d873b529a465d7df675419d823abf06bb7cac4549a9db0e7e365b4026ed1ef6b6d3d8c98daacd8091b8e74c8366e6628c885418a52e9b5d40c8100605c3b279ca20dd7298dead7f14f03b0e9d25cc2543bf5fc46a1825a1a1714a2a2e4e94507997e923b13e036ffbcffd41741d3ee2604586fe29593899fe73ee57e18706f835c4b7f4845ef759b767c88c272075a4080416d5292727477339ea5ce5a152cd66773e43701f94e0d2cfbe9e42a32aea4bfe2624c90cd9dafe9ac42e1fe7499b1bec1fefc05ac231cb3f3dfee7785924a6e99924b6e79257ebccc9fa2ffd8dcf4c29f829f2909facb38a3f85a8de8c866285d2a030c2bf50f86518c5548f980314ee90fac69fd9eab18fc1228bceb7f996b1a4e3584b7508afddf85bc8129293f853b2805dfdc81b4808381a84b80bc9b481722b90857ea2cd45f1845463e422855706925c1b6180f23d9df4cc6b15f95cc18871e7c6c1a65ba836ebf69ba38c0dcbd7b5267a3243739246de49934ef6738acb4d77018b8bef64aec9bdb3937442860dd89e68ae331522dadcb507ff5a02de1eb383cf47f3d4bbf32f83f369b2c8b9f9246bf3749cdc95e268f9e88ab49da37095bfe6a655feee1940a532d73817ed8f65d696edb6a0c5b0cc5755470dfa57296eea083e0b16bee0a21d5dc22e7ce8956c1c09dded654340e42fc9ae05c6f13df808df31715892562895bc238a3cea27700ab93a39072c778c7b280aab72b52b684acdb50ca2aa30845ae5c231599b80d7bb8a93422a3a6423f174cfaf9fea4f0c2dc91b8cadf4e7e335452f32715c88925ec98a24ba3027aeefa9c67d32f0ed75c8ec27197df2cea9eb437796614bd21410a778ecaedf7e9727b1cbf4741bdfbd74aaa41162c760da6d1603fab8f13d23fc936c732b01eb7771057ff144ac84b8f3b7b52047561d41cec8e7d2b232d8966c8410ddaf703c6b86479e3de8a9300f8ff4dc69dc4f88cd54807d22046f3ffe6398398d4c46c0bf8062ecde57d774c05bcdbf862b11aaa836db73fab0e12dfd9e151db61775c9fbf45f798108d39d280364b542f1dac236522f87c9df0d08783edb85187340b1ddcbfda183776929cface8589d55b9534e6f87e128def94a58515042b753275518ab3e63d305aea4f38b020d816dd867e91816f04af4e50a42604ee87d1084a6f6e9a368cb75d8be0db592fc686cc619afa012dcfcd0ebf5a2665e0ee428caebb4ec81c7285998be9fae1c0addae6f6d9322606e052e7c517472291ce63561e94b955899b2cb168d1a74e71a26fce5c05ed0d6f59d40a908a76e99352ad20ce3b82c0896814f6c7fa1b22dc766458d569925b3d0f17513d4458175b738d2f31f437fc30cba8f9c4e60d9e8c8aa74a569350276c6eb33785bb516490609d80b63126a8067ccbcff8a94f154ba9ee15d53f4f1a05e0dcd05ae2c5258464d5ba09f74245410112c781741745ad0d0662e7b6774fc0f20471645a1ac1e3bd3b16f06c7e02e779071d955b1f691877fd37d6af1e023d94383c621f6b7531a4742ac856181237b4bdf07811ea670e29b3b0e69a447651b9337d0bcf4b407b0d7bdd74afb2cb47cacb78574e46a5a12af625fe9c7ca119d596d7742dbba8df1b59836c867611e942df5565ad8aa07d56b8905de818ebddc9454154db4ec29602a5af41e61149bdccafb682b2afbd0ccb2ac7e941fff0c445cbdef5f9ec1cfb7cfab93d1a7da5ec66d321e5e3f97d2e30aabc5d520f27ca33bbdde1e8501ac2f0a714dab49189ea29f44b8def7cf3f46c8ab8bb557a9169639da9e7f2bead11d6e733b1e4f34454daf6dcdfd3151183c6f7e44882f7359807a6c79491b3be5e6a50d0e7f80d5a7e3b1c74d908203c5448bb4cbd22a79e20509a23a5ebc7d7e8d08c24659cbb21b01e5e476852dc3c237d1ba15d20986146e55a207656bca90eeaa9439fe648ef3abc13fd756880f7092f68e5933401efe5f76766722b8dbfe432e33587f29126d53723dd7aa17510784ebd1329ad312442a9fb891d523279a69fa9a69e6a6ea3b4b568a2683de827aebfea62250616fe36ad1b856b1d93454f444ba63bb2c35ae54d859bb34934a70e3d9ce30204f75fcf6ae53f6af2cf272c8ac894f874754609988bde2197f0f2f76c8593103dfdc1b9e0675aa342bcd10128a868f8a73a312a71805c0e72792827a85bebfa30f18ba24080aa0c3c4ea863758b9cbc8f61faa255e07559311b70e996fe2b555d2e71b754fae720f050c73efcd6078d142e574a16349cf77fa59334391215107f779ad0be52cc441cd5dc366249cd4ed9aeff64db520fe0aea0811963b17e42d42e6e3b600a8bff2aed2ff4a1e7b53fe1212ddc5369bd73b714c279a9d906b7821e7e5ad5ea9589562852cfaf9fe2ace553bb1489b799824a0b18336170fac7795a4ed2d285679749055ab992f7217d2622f6d07a74190e906c24c7b3f6c4dfe73b97c0f47cc272880b2fca5bd45183c85f93be1d9afcdc3145c714065e5b9efa5c1b4bda2900a720fcc4970bce297fa040f25dc413f60819eac855dc7714eb545e001c326f06e8f05b64f1e1f498a37ec69f8c92710edd05dec1f8d9b68dd8d0eff460e18de762bc397738f736442f3777e45e8937f4358cd9104e2d505cad9be44fe275ff37d42f93b4516ce8d8ccaf37feeaef3636c9f990ffcf7dacaa9a6ad94dd2d294de3a531848c11e70b39cb6e9581996861259749c0c12f20fdfafd9e3ba8a13465272dcd68c069a7c74407dbbbc2e190708f433cb51f7761ed9bd085991a2a634bb2d88ae12321e5bf730532e23fae44176cb13b82a06c39a0bf4148c3496cbca12609ec842a6e1c7ab521dc273e3b1768bd8e56a3babf055334da926f6438ccc8c382eb2331f5dd99b6921313f16e6afcc3a88da1a61535030ad64815ad179f64d5c764e148dc674f671a7dce09cc40ae6d2eec2d308bea65c8329b2bdd0cbb0c442153266eabe10c1238efba7c7996234eeb050ad47e10ad26be1d356a491a023e80df634f9279d450109b9dcc69740a55d5be2cd6c20ad9bd8967d62255cf44ac59add5ba54818d6e4d5cde5aa03de4b867a10d35e6d365d0931bfdd0592dc17ac64a80da4b67bb5387cc4d9fadaa1394b2a46eaa07f2aba2b6209de3eec706290c27f102a772375505469fd59162ce58bbcf87ac64d33a803939525bf11c5170d90286bc0e0114827d13246d9ed69e16d9616af22e8451c3522ad524801454d5c25f3abcbc1a3e2055e6959136c6b01ee775fa6917ae1a674bc4129a973d5e347f2df66031414e3e40cef7c02432b7ea9c758fb2dc88647cef4eb093ddc8a359180412c16f6ca4726e3cde3262c4019df888b430ce7728fe508e083bcb6f3384fb4609b56c0c18b431a06a1a6072dbd7a86d72af95235ee4f71cfb8ffac52a0c3b0af0a233eaf2005dee1aa685c10729cb500a459eec491bf76b36767f913d053d0867ba3f0f5801f6c0084ffc2d29f9086796e31c88c94ffc7a9230397bdaca1df3d80dd45c12259495b1fcf7e0f8eeef72d716285487ca89eb048dba9217389041258acf4b55162d2c4abd617347a5cd8c64b014d0f383e2ba012599e3cb1cb1691ac5b828e9f5ad41f9cfb3ee19c80759d501f64171c4352f8b20c3b7cb7d6324e661c4744bfeaf557eedc90df09794d92a6a7e14eeb68380c3df5aa701e0bf94f39af6eb9633709a55eb971bb8929233d6ab9e988ce6ca2b590562d4186861e6212ef51717a6271b5940a452cf2954abcc08ef3b41ef60e4d96d160b1f4d72ee332c8271ca497e2cdb2e7b0412c7b9b64892b47a40f42a22e41eabbd6d3b6af43cd44f8fc03739c2bd0ad7fcb6a944fe7020d40d8b83bf261d05f30ce0a6ef5489de89b76a071ebebcbda578c8bfa30082d8f0ab9d93cd5866a3b52024e5eae194697620838f9f4b4fa2889bf21095097008b661cc9c9eba1761c6ae98fc99a429afae9ec3a2c56631cebc6fa3d92c5b5fa7cf5a008cff849ded723adb0a8a2be019dffebd73b8aaab4f4e0e1eac01ce5c284cec7afa720175b42fbbc819561672890f636203b104fbc40f8f6467ad6f268e99cd51600ad0cfaa7b54d6ff86bf049443e619968209a63576d0953c810669d7c89cbcb0927eab931529e84403e1faff58f6ace6d4e11c7b892290760009e950d94e6d68fa38180009fb92bab34c88e931023885400d9efa67e85d7111905eb5cf9232bb860816085054e62e13e85a5e627116fa550c005ce14e585ca27807cd70b78e7eae4520ee4fa7218d335dc44ed9cebf68c2571e239391b76ea6286b303e2045a1803679b268a2214546aa336c25dcc75a866f11d16eef7f0b378815aff07835a60a916d6c1e0e3ddb512251d4c116f5ca7e53c23a65496e47a62e4f313a228a0c2bf9362f655d3b055dad7a7bdec6cb0d4bacd81c7fd7b15189beb668f3d91e7920e22589eb6549c23e69baac979159ae6bea9164edae4cc77aefbdb0fd08b2faebca0662be878de5dbb9b4ff740acad09d78d5cd38a3bb895d12dbe6535fde2a736b6a35f7acbf7dfad9e79bfe7287c1836c594f8bc52672a6916185f4059773580c679ecd6d6c5ad0c4aac09c8d402395ce31e3647f91e98dc898efb59e1b9d5726e2621930c1d4443e7e7985cef9aaccdd58474d248ea465bdd093c590ebaf727437879051d1c357a63f01b66fb607607cfc6fb32cc22ad7be845df3646a46c03cac7e3c4cd750f04ff5320688db246f2487ad553b3112207d2b22ef1a41929bbd1e3202488b16f0832b06b891cb3abfc3bf02d579a47fda9c7bad5ea1a50a04cb0bc42a1c6d646bdbd828084ba21831f99df213c681c82ee6fcf83729586520f341b522f9adbe59fc26a10c935c44bc239fb5d6a9fb61d32ba8650c25df5135046ec50a830f0e5209089a1db0134d0026a79165bcfe170ad6135fb65487fd7a6745d3f0e4464b8f8786252cbff781076f5f22973c2029c4803e1215e87e4cd7c0cbea38fe6b308990cdf298b1de8e1fea3f3341f535ab75b1939f6552717c4ffb4b2f086fad47685f49d72731f4aebf43750fa792f828f109c5f47b852ff1c84fc088fb8c67050c60c02d29fa386bf31e40576172fe56dd4d22baebd3dff6dd3f584082da631fe8884aa4e469c466a5f1ec3f9832e419aea01ae7957f9750e90e6730046ccd18b09d01ad3b7700cb41dc70708833fe184f3f2e519e3caee016dc86fade3433506e17224ff50fd454e948b6519b4899baa2edff8ccf49dc4edf8f372c48627bad421a8d63922424706b996e62b3b1b384db2b4c70109134f30545da7bed2d4ec7496a4f8234b61a1bdc8e21345d9e3f87e0a273c5b5c73757aafb0b2d000000000000000000000000000000000000000000000000000000000060a12161d22232f"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(ShanghaiSigner{ChainId: big.NewInt(1)}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

// TestTransactionCoding tests serializing/de-serializing to/from rlp and JSON.
func TestTransactionCoding(t *testing.T) {
	key, err := pqcrypto.GenerateDilithiumKey()
	if err != nil {
		t.Fatalf("could not generate key: %v", err)
	}
	var (
		signer       = NewShanghaiSigner(common.Big1)
		addr, _      = common.NewAddressFromString("Z0000000000000000000000000000000000000001")
		recipient, _ = common.NewAddressFromString("Z095e7baea6a6c7c4c2dfeb977efac326af552d87")
		accesses     = AccessList{{Address: addr, StorageKeys: []common.Hash{{0}}}}
	)
	for i := uint64(0); i < 500; i++ {
		var txdata TxData
		switch i % 5 {
		case 0:
			// Dynamic fee tx.
			txdata = &DynamicFeeTx{
				Nonce:     i,
				To:        &recipient,
				Gas:       1,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 1:
			// Dynamic fee tx contract creation.
			txdata = &DynamicFeeTx{
				Nonce:     i,
				Gas:       1,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 2:
			// Tx with non-zero access list.
			txdata = &DynamicFeeTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				To:         &recipient,
				Gas:        123457,
				GasFeeCap:  big.NewInt(2),
				GasTipCap:  big.NewInt(0),
				AccessList: accesses,
				Data:       []byte("abcdef"),
			}
		case 3:
			// Tx with empty access list.
			txdata = &DynamicFeeTx{
				ChainID:   big.NewInt(1),
				Nonce:     i,
				To:        &recipient,
				Gas:       123457,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 4:
			// Contract creation with access list.
			txdata = &DynamicFeeTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				Gas:        123457,
				GasFeeCap:  big.NewInt(2),
				GasTipCap:  big.NewInt(0),
				AccessList: accesses,
			}
		}
		tx, err := SignNewTx(key, signer, txdata)
		if err != nil {
			t.Fatalf("could not sign transaction: %v", err)
		}
		// RLP
		parsedTx, err := encodeDecodeBinary(tx)
		if err != nil {
			t.Fatal(err)
		}
		if err := assertEqual(parsedTx, tx); err != nil {
			t.Fatal(err)
		}

		// JSON
		parsedTx, err = encodeDecodeJSON(tx)
		if err != nil {
			t.Fatal(err)
		}
		if err := assertEqual(parsedTx, tx); err != nil {
			t.Fatal(err)
		}
	}
}

func encodeDecodeJSON(tx *Transaction) (*Transaction, error) {
	data, err := json.Marshal(tx)
	if err != nil {
		return nil, fmt.Errorf("json encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := json.Unmarshal(data, &parsedTx); err != nil {
		return nil, fmt.Errorf("json decoding failed: %v", err)
	}
	return parsedTx, nil
}

func encodeDecodeBinary(tx *Transaction) (*Transaction, error) {
	data, err := tx.MarshalBinary()
	if err != nil {
		return nil, fmt.Errorf("rlp encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := parsedTx.UnmarshalBinary(data); err != nil {
		return nil, fmt.Errorf("rlp decoding failed: %v", err)
	}
	return parsedTx, nil
}

func assertEqual(orig *Transaction, cpy *Transaction) error {
	if want, got := orig.Hash(), cpy.Hash(); want != got {
		return fmt.Errorf("parsed tx differs from original tx, want %v, got %v", want, got)
	}
	if want, got := orig.ChainId(), cpy.ChainId(); want.Cmp(got) != 0 {
		return fmt.Errorf("invalid chain id, want %d, got %d", want, got)
	}
	if orig.AccessList() != nil {
		if !reflect.DeepEqual(orig.AccessList(), cpy.AccessList()) {
			return fmt.Errorf("access list wrong!")
		}
	}
	return nil
}

func TestTransactionSizes(t *testing.T) {
	signer := NewShanghaiSigner(big.NewInt(123))
	key, _ := pqcrypto.HexToDilithium("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
	to, _ := common.NewAddressFromString("Z00000000000000000000000000000000000000001")
	for i, txdata := range []TxData{
		&DynamicFeeTx{
			ChainID:   big.NewInt(123),
			Nonce:     1,
			GasFeeCap: big.NewInt(500),
			Gas:       1000000,
			To:        &to,
			Value:     big.NewInt(1),
			AccessList: AccessList{
				AccessTuple{
					Address:     to,
					StorageKeys: []common.Hash{common.HexToHash("0x01")},
				}},
		},
		&DynamicFeeTx{
			ChainID:   big.NewInt(123),
			Nonce:     1,
			Gas:       1000000,
			To:        &to,
			Value:     big.NewInt(1),
			GasTipCap: big.NewInt(500),
			GasFeeCap: big.NewInt(500),
		},
	} {
		tx, err := SignNewTx(key, signer, txdata)
		if err != nil {
			t.Fatalf("test %d: %v", i, err)
		}
		bin, _ := tx.MarshalBinary()

		// Check initial calc
		if have, want := int(tx.Size()), len(bin); have != want {
			t.Errorf("test %d: size wrong, have %d want %d", i, have, want)
		}
		// Check cached version too
		if have, want := int(tx.Size()), len(bin); have != want {
			t.Errorf("test %d: (cached) size wrong, have %d want %d", i, have, want)
		}
		// Check unmarshalled version too
		utx := new(Transaction)
		if err := utx.UnmarshalBinary(bin); err != nil {
			t.Fatalf("test %d: failed to unmarshal tx: %v", i, err)
		}
		if have, want := int(utx.Size()), len(bin); have != want {
			t.Errorf("test %d: (unmarshalled) size wrong, have %d want %d", i, have, want)
		}
	}
}
